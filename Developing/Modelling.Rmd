---
title: "Modelling"
output: html_notebook
---

Este script se hace con el propósito estimar modelos de tiempo de viaje a partir de los datos obtenidos de Fiscalización. Para esto se construyen modelos desde los más simple a los más complejos, utilizando diversas variables que permiten controlar su efecto en el tiempo de viaje y aislar así el impacto del uso de torniquete mariposa.

```{r Functions, include=FALSE}


##Function to load libraries and install packages, if necessary
getLibraries <- function(libs) {
  
  for (lib in libs) {
    if(!lib %in% rownames(installed.packages())){install.packages(lib, repos = "http://cran.us.r-project.org")}
    library(as.character(lib), character.only = TRUE)
  }
}

libs <- c("data.table",
          "plyr",
          "lubridate",
          "chron",
          "ggplot2",
          "ggpubr",
          "gridExtra",
          "stringr",
          "fuzzyjoin",
          "sqldf",
          "plotly",
          "shiny")

getLibraries(libs)
```

```{r Input, include=FALSE}
#Setting working directory
setwd("/Users/diego/Desktop/Evasion/01_analisis/03_datos/12_Bases_modelo/")

#Reading input files
database <- read.csv(file = "data_modelo_X5.csv", header = TRUE, sep = ";")
```

```{r Variables, include=FALSE}

#Cambiando unidad de medida de largo del recorrido (Kms.)
database$largo_ruta <- database$largo_ruta/1000

#One hot encoding for periods of time
periodos <- as.data.frame(model.matrix(~database$Periodo-1))
names(periodos) <- sprintf("P%s",3:10)
periodo_punta <- periodos$P4 + periodos$P9

#NI peak
database$NI_peak <- database$NI * periodo_punta

#Demanda en periodo punta
database$Y_peak <- database$Y * periodo_punta

#Agregando trimestre único
database$U_TRI <- database$TRI
database$U_TRI[which(substr(database$FECHA,1,4) == "2017" & database$TRI == 1)] <- 5
database$U_TRI[which(substr(database$FECHA,1,4) == "2017" & database$TRI == 2)] <- 6
database$U_TRI[which(substr(database$FECHA,1,4) == "2017" & database$TRI == 3)] <- 7
database$U_TRI[which(substr(database$FECHA,1,4) == "2017" & database$TRI == 4)] <- 8

#Variable por presencia de torniquete de tres brazos
database$turnstile_3b <- 0
database$turnstile_3b[which(database$turnstile==1 & database$turnstile_marip==0)] <- 1

#Demanda con torniquete mariposa y de trez brazos en periodos punta.
database$Y_peak_marip <- database$Y * periodo_punta * database$turnstile_marip
database$Y_peak_3b <- database$Y * periodo_punta * database$turnstile_3b

#Demanda con torniquete mariposa y torniquete de tres brazos.
database$Y_marip <- database$Y * database$turnstile_marip
database$Y_3b <- database$Y * database$turnstile_3b
```



# Travel time models
A continuación se crean modelos econométricos para estimar el tiempo medio de viaje controlando por el efecto de distintas variables, como el uso de torniquete mariposa. 

### Modelo 1

El primer modelo es un modelo simple que incluye el largo del recorrido, el número de detenciones, la demanda total y el número de intersecciones semaforizadas, $i.e.$

$T = c + t_{L} \cdot L + t_{s} \cdot S + t_{Y}\cdot Y + t_{I} \cdot N_{I}$


```{r Modelo1, echo=FALSE}

data.all <- data.frame(database$TEXP, database$largo_ruta, database$DET, database$Y, database$NI)
names(data.all) <- c("texp","largo","det","Y","NI")

modelo_01 <- lm(as.formula("texp~."), data = data.all)
summary(modelo_01)
```


### Modelo 2

Este modelo corresponde a una extensión del modelo anterior, pero se considera un tiempo extra por demora (o ahorro) en intersecciones semaforizadas y por la demanda cuando el viaje se hace en periodos punta (punta mañana o punta tarde).

$T = c + t_{L} \cdot L + t_{s} \cdot S + \Big( t_{Y} + t_{Y}^{'} \cdot \gamma_{peak} \Big) \cdot Y + \Big( t_{I} + t_{I}^{'} \cdot \gamma_{peak} \Big) \cdot N_{I}$

```{r Modelo2, echo=FALSE}

#Creating dataframe
data.all <- data.frame(database$TEXP, database$largo_ruta, database$DET, database$Y, database$Y_peak, database$NI, database$NI_peak)
names(data.all) <- c("texp","largo","DET","Y","Y_peak","NI","NI_peak")

#Fitting the model
modelo_02 <- lm(as.formula("texp~."), data = data.all)
summary(modelo_02)

```

### Modelo 3

Corresponde a una extensión del modelo anterior. En este se agrega una variable de demora extra por el trimestre de medición, rescatando la tendencia de aumento en los tiempos de viaje de los buses a lo largo del tiempo.

$T = c + t_{L} \cdot L + t_{TRI} \cdot TRI + t_{s} \cdot S + \Big( t_{Y} + t_{Y}^{'} \cdot \gamma_{peak} \Big) \cdot Y + \Big( t_{I} + t_{I}^{'} \cdot \gamma_{peak} \Big) \cdot N_{I}$

```{r Modelo3, echo=FALSE}

#Creating dataframe
data.all <- data.frame(database$TEXP, 
                       database$largo_ruta, 
                       database$U_TRI, 
                       database$DET, 
                       database$Y, 
                       database$Y_peak, 
                       database$NI, 
                       database$NI_peak)

names(data.all) <- c("texp","largo","TRI", "DET","Y","Y_peak","NI","NI_peak")

#Fitting the model
modelo_03 <- lm(as.formula("texp~."), data = data.all)
summary(modelo_03)

```


### Modelo 4

Este modelo es una extensión del modelo anterior, pero además considera una demora extra en periodos punta si es que existe la presencia de torniquete mariposa o de tres brazos.

$T = c + t_{L} \cdot L + t_{TRI} \cdot TRI + t_{s} \cdot S + \Big( t_{Y} + \Big(t_{Y}^{'} + t_{Y}^{''} \cdot \gamma_{marip} + t_{Y}^{'''} \cdot \gamma_{3B} \Big) \cdot \gamma_{peak} \Big) \cdot Y + \Big( t_{I} + t_{I}^{'} \cdot \gamma_{peak} \Big) \cdot N_{I}$

```{r Modelo4, echo=FALSE}

#Creating dataframe
data.all <- data.frame(database$TEXP, 
                       database$largo_ruta, 
                       database$U_TRI, 
                       database$DET, 
                       database$Y, 
                       database$Y_peak,
                       database$Y_peak_marip,
                       database$Y_peak_3b,
                       database$NI, 
                       database$NI_peak)

names(data.all) <- c("texp","largo","TRI", "DET","Y","Y_peak","Y_peak_marip","Y_peak_3b","NI","NI_peak")

#Fitting the model
modelo_04 <- lm(as.formula("texp~."), data = data.all)
summary(modelo_04)

```

### Modelo 5
Corresponde al modelo anterior, pero eliminando los tiempos extras por expediciones realizadas en periodos punta, es decir, se considera la demanda, y demoras extras si esa demanda se enfrenta a torniquete mariposa y a torniquete de tres brazos.

$T = c + t_{L} \cdot L + t_{TRI} \cdot TRI + t_{s} \cdot S + \Big( t_{Y} +  t_{Y}^{'} \cdot \gamma_{marip} + t_{Y}^{''} \cdot \gamma_{3B} \Big) \cdot Y + \Big( t_{I} + t_{I}^{'} \cdot \gamma_{peak} \Big) \cdot N_{I}$

```{r Modelo5, echo=FALSE}
#Creating dataframe
data.all <- data.frame(database$TEXP, 
                       database$largo_ruta, 
                       database$U_TRI, 
                       database$DET, 
                       database$Y, 
                       database$Y_marip,
                       database$Y_3b,
                       database$NI, 
                       database$NI_peak)

names(data.all) <- c("texp","largo","TRI", "DET","Y","Y_marip","Y_3b","NI","NI_peak")

#Fitting the model
modelo_05 <- lm(as.formula("texp~."), data = data.all)
summary(modelo_05)
```


### Modelo 6

Corresponde a una extensión del Modelo 4, agregando además efectos de torniquete mariposa y de tres brazos en periodos fuera de punta, $i.e.$

$T = c + t_{L} \cdot L + t_{TRI} \cdot TRI + t_{s} \cdot S + \Big( t_{Y} + t_{Y}^{'} \cdot \gamma_{marip} + t_{Y}^{''} \cdot \gamma_{3B} + \Big(t_{Y}^{'''} + t_{Y}^{''''} \cdot \gamma_{marip} + t_{Y}^{'''''} \cdot \gamma_{3B} \Big) \cdot \gamma_{peak} \Big) \cdot Y + \Big( t_{I} + t_{I}^{'} \cdot \gamma_{peak} \Big) \cdot N_{I}$


```{r Modelo6, echo=FALSE}
#Creating dataframe
data.all <- data.frame(database$TEXP, 
                       database$largo_ruta, 
                       database$U_TRI, 
                       database$DET, 
                       database$Y,
                       database$Y_marip,
                       database$Y_3b,
                       database$Y_peak,
                       database$Y_peak_marip,
                       database$Y_peak_3b,
                       database$NI, 
                       database$NI_peak)

names(data.all) <- c("texp",
                     "largo",
                     "TRI", 
                     "DET",
                     "Y",
                     "Y_marip", 
                     "Y_3B", 
                     "Y_peak",
                     "Y_peak_marip",
                     "Y_peak_3b",
                     "NI",
                     "NI_peak")

#Fitting the model
modelo_06 <- lm(as.formula("texp~."), data = data.all)
summary(modelo_06)
```





### Modelo X

Debido a la imposibilidad de cálculo del número de intersecciones semaforizadas de manera rigurosa (bases poco prolijas) y a probable correlación entre el número de intersecciones semaforizadas con el número de detenciones (0.62) se decide probar con dummies por cada una de las rutas (servicio-sentido). Esto tiene a su vez como argumento que el número de intersecciones y paraderos son características en generales propias del trazado del servicio-sentido. Este modelo, además considera el largo del recorrido y la demanda como variables explicativas del tiempo de viaje. Dentro del modelo finalmente reportado, solo se consideran variables de rutas estadísticamente significativas, eliminando a través de un loop todas aquellas que no lo sean en cada iteración.

$T = c + t_{L} \cdot L  + t_{Y} \cdot Y +  \sum_{r}  t_{r} \cdot  \gamma_{r}$

```{r ModeloX, echo=FALSE}

rutas <- as.data.frame(model.matrix(~database$COD_USU_SENTIDO-1))
names(rutas) <- substr(names(rutas),nchar(names(rutas)) - 3,nchar(names(rutas)))
  
#Deleting route 101I (base)
rutas <- rutas[,-1]

ind_pvalor <- length(database)

while(length(ind_pvalor) != 0){
  
  data.all <- data.frame(database$TEXP, database$largo_ruta, database$Y)
  names(data.all) <- c("texp","largo","Y")
  
  data.all <- cbind(data.all, rutas)
  
  modelo_0X <- lm(as.formula("texp~."), data = data.all)
  summary(modelo_0X)
  test_summary <- data.frame(summary(modelo_0X)[[4]])
  test_summary <- test_summary[4:nrow(test_summary),]
  
  ind_pvalor <- which(test_summary$Pr...t.. > 0.05)
  
  #Keeping routes statistically significant
  if(length(ind_pvalor != 0)){rutas <- rutas[,-ind_pvalor]}
}

summary(modelo_0X)

```


### Modelo X+1

El tercer modelo corresponde a una extensión del segundo, pero considerando una dummy por la demanda en aquellas expediciones que utiliza torniquete.

$T = c + t_{L} \cdot L  + \Big( t_{Y} + t_{Y}^{'} \cdot \gamma_{torn} \Big) \cdot Y + \sum_{r} t_{r} \gamma_{r} $

```{r ModeloX+1, echo=FALSE}



#Demanda en expediciones con torniquete
Y_turnstile <- database$Y * database$turnstile


rutas <- as.data.frame(model.matrix(~database$COD_USU_SENTIDO-1))
names(rutas) <- substr(names(rutas),nchar(names(rutas)) - 3,nchar(names(rutas)))
  
#Deleting route 101I (base)
rutas <- rutas[,-1]

ind_pvalor <- length(database)

while(length(ind_pvalor) != 0){
  
  data.all <- data.frame(database$TEXP, database$largo_ruta, database$Y, Y_turnstile)
  names(data.all) <- c("texp","largo","Y","Y_turnstile")
  
  data.all <- cbind(data.all, rutas)
  
  modelo_02 <- lm(as.formula("texp~."), data = data.all)
  summary(modelo_02)
  test_summary <- data.frame(summary(modelo_02)[[4]])
  test_summary <- test_summary[5:nrow(test_summary),]
  
  ind_pvalor <- which(test_summary$Pr...t.. > 0.05)
  
  #Keeping routes statistically significant
  if(length(ind_pvalor != 0)){rutas <- rutas[,-ind_pvalor]}
}
```

