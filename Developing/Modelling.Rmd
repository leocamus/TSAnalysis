---
title: "Modelling"
output: html_notebook
---

Este script se hace con el propósito estimar modelos de tiempo de viaje a partir de los datos obtenidos de Fiscalización. Para esto se construyen modelos desde los más simple a los más complejos, utilizando diversas variables que permiten controlar su efecto en el tiempo de viaje y aislar así el impacto del uso de torniquete mariposa.
            

```{r Functions, include=FALSE}


##Function to load libraries and install packages, if necessary
getLibraries <- function(libs) {
  
  for (lib in libs) {
    if(!lib %in% rownames(installed.packages())){install.packages(lib, repos = "http://cran.us.r-project.org")}
    library(as.character(lib), character.only = TRUE)
  }
}

libs <- c("data.table",
          "plyr",
          "lubridate",
          "chron",
          "ggplot2",
          "ggpubr",
          "gridExtra",
          "stringr",
          "fuzzyjoin",
          "sqldf",
          "plotly",
          "shiny",
          "stargazer",
          "memisc",
          "pander")

getLibraries(libs)
```

```{r Input, include=FALSE}
#Setting working directory
setwd("/Users/diego/Desktop/Evasion/01_analisis/03_datos/12_Bases_modelo/")

#Reading input files
database <- read.csv(file = "data_modelo_X5.csv", header = TRUE, sep = ";")
```

```{r Variables, include=FALSE}

#Cambiando unidad de medida de largo del recorrido (Kms.)
database$largo_ruta <- database$largo_ruta/1000

database$COD_USU_SENTIDO <- as.character(database$COD_USU_SENTIDO)

#One hot encoding for periods of time
periodos <- as.data.frame(model.matrix(~database$Periodo-1))
names(periodos) <- sprintf("P%s",3:10)
periodo_punta <- periodos$P4 + periodos$P9

database <- cbind(database, periodos)
database$Punta <- periodo_punta

#One hot encoding for Unidad de Negocio
UN <- as.data.frame(model.matrix(~database$UN-1))
names(UN) <- sprintf("U%s",1:7)

database <- cbind(database, UN)

#NI peak
database$NI_peak <- database$NI * periodo_punta

#Demanda en periodo punta
database$Y_peak <- database$Y * periodo_punta

#Agregando trimestre único
database$U_TRI <- database$TRI
database$U_TRI[which(substr(database$FECHA,1,4) == "2017" & database$TRI == 1)] <- 5
database$U_TRI[which(substr(database$FECHA,1,4) == "2017" & database$TRI == 2)] <- 6
database$U_TRI[which(substr(database$FECHA,1,4) == "2017" & database$TRI == 3)] <- 7
database$U_TRI[which(substr(database$FECHA,1,4) == "2017" & database$TRI == 4)] <- 8

#Variable por presencia de torniquete de tres brazos
database$turnstile_3b <- 0
database$turnstile_3b[which(database$turnstile==1 & database$turnstile_marip==0)] <- 1

#Demanda con torniquete mariposa y de trez brazos en periodos punta.
database$Y_peak_marip <- database$Y * periodo_punta * database$turnstile_marip
database$Y_peak_3b <- database$Y * periodo_punta * database$turnstile_3b

#Demanda con torniquete mariposa y torniquete de tres brazos.
database$Y_marip <- database$Y * database$turnstile_marip
database$Y_3b <- database$Y * database$turnstile_3b


#Se construye un dataset sin considerar torniquete de tres brazos
dataset <- database[-which(database$turnstile_3b==1),]
dataset$turnstile_3b <- NULL
dataset$Y_peak_3b <- NULL
dataset$Y_3b <- NULL

dataset_original <- dataset
```



# Travel time models
A continuación se crean modelos econométricos para estimar el tiempo medio de viaje controlando por el efecto de distintas variables, como el uso de torniquete mariposa. 

### Modelo 1

El primer modelo es un modelo simple que incluye el largo del recorrido, el número de detenciones, la demanda total y el número de intersecciones semaforizadas, $i.e.$

$T = c + t_{L} \cdot L + t_{s} \cdot S + t_{Y}\cdot Y + t_{I} \cdot N_{I}$


```{r Modelo1, echo=FALSE}

data.all <- data.frame(database$TEXP, database$largo_ruta, database$DET, database$Y, database$NI)
names(data.all) <- c("texp","largo","det","Y","NI")

modelo_01 <- lm(as.formula("texp~."), data = data.all)
summary(modelo_01)
```


### Modelo 2

Este modelo corresponde a una extensión del modelo anterior, pero se considera un tiempo extra por demora (o ahorro) en intersecciones semaforizadas y por la demanda cuando el viaje se hace en periodos punta (punta mañana o punta tarde).

$T = c + t_{L} \cdot L + t_{s} \cdot S + \Big( t_{Y} + t_{Y}^{'} \cdot \gamma_{peak} \Big) \cdot Y + \Big( t_{I} + t_{I}^{'} \cdot \gamma_{peak} \Big) \cdot N_{I}$

```{r Modelo2, echo=FALSE}

#Creating dataframe
data.all <- data.frame(database$TEXP, database$largo_ruta, database$DET, database$Y, database$Y_peak, database$NI, database$NI_peak)
names(data.all) <- c("texp","largo","DET","Y","Y_peak","NI","NI_peak")

#Fitting the model
modelo_02 <- lm(as.formula("texp~."), data = data.all)
summary(modelo_02)

```

### Modelo 3

Corresponde a una extensión del modelo anterior. En este se agrega una variable de demora extra por el trimestre de medición, rescatando la tendencia de aumento en los tiempos de viaje de los buses a lo largo del tiempo.

$T = c + t_{L} \cdot L + t_{TRI} \cdot TRI + t_{s} \cdot S + \Big( t_{Y} + t_{Y}^{'} \cdot \gamma_{peak} \Big) \cdot Y + \Big( t_{I} + t_{I}^{'} \cdot \gamma_{peak} \Big) \cdot N_{I}$

```{r Modelo3, echo=FALSE}

#Creating dataframe
data.all <- data.frame(database$TEXP, 
                       database$largo_ruta, 
                       database$U_TRI, 
                       database$DET, 
                       database$Y, 
                       database$Y_peak, 
                       database$NI, 
                       database$NI_peak)

names(data.all) <- c("texp","largo","TRI", "DET","Y","Y_peak","NI","NI_peak")

#Fitting the model
modelo_03 <- lm(as.formula("texp~."), data = data.all)
summary(modelo_03)

```


### Modelo 4

Este modelo es una extensión del modelo anterior, pero además considera una demora extra en periodos punta si es que existe la presencia de torniquete mariposa o de tres brazos.

$T = c + t_{L} \cdot L + t_{TRI} \cdot TRI + t_{s} \cdot S + \Big( t_{Y} + \Big(t_{Y}^{'} + t_{Y}^{''} \cdot \gamma_{marip} + t_{Y}^{'''} \cdot \gamma_{3B} \Big) \cdot \gamma_{peak} \Big) \cdot Y + \Big( t_{I} + t_{I}^{'} \cdot \gamma_{peak} \Big) \cdot N_{I}$

```{r Modelo4, echo=FALSE}

#Creating dataframe
data.all <- data.frame(database$TEXP, 
                       database$largo_ruta, 
                       database$U_TRI, 
                       database$DET, 
                       database$Y,
                       database$Y_peak,
                       database$Y_peak_marip,
                       database$Y_peak_3b,
                       database$NI, 
                       database$NI_peak)

names(data.all) <- c("texp",
                     "largo",
                     "TRI", 
                     "DET",
                     "Y",
                     "Y_peak",
                     "Y_peak_marip",
                     "Y_peak_3B",
                     "NI",
                     "NI_peak")

#Fitting the model
modelo_04 <- lm(as.formula("texp~."), data = data.all)
summary(modelo_04)

```


### Modelo 5

Dado que solo buses de la Unidad 2 tienen torniquete de tres brazos, no parece correcto controlar por el uso de dicho torniquete, pues implícitamente está el control por la unidad de negocio señalada (lo que tiene otro tipo de consideraciones). Por esta razón se controla solo por uso de torniquete mariposa y se agrega torniquete de tres brazos en no torniquete $i.e.$

$T = c + t_{L} \cdot L + t_{TRI} \cdot TRI + t_{s} \cdot S + \Big( t_{Y} + \Big(t_{Y}^{'} + t_{Y}^{''} \cdot \gamma_{marip} \Big) \cdot \gamma_{peak} \Big) \cdot Y + \Big( t_{I} + t_{I}^{'} \cdot \gamma_{peak} \Big) \cdot N_{I}$

```{r Modelo5, echo=FALSE}

#Creating dataframe
data.all <- data.frame(database$TEXP, 
                       database$largo_ruta, 
                       database$U_TRI, 
                       database$DET, 
                       database$Y,
                       database$Y_peak,
                       database$Y_peak_marip,
                       database$NI, 
                       database$NI_peak)

names(data.all) <- c("texp",
                     "largo",
                     "TRI", 
                     "DET",
                     "Y",
                     "Y_peak",
                     "Y_peak_marip",
                     "NI",
                     "NI_peak")

#Fitting the model
modelo_05 <- lm(as.formula("texp~."), data = data.all)
summary(modelo_05)

```


### Modelo 6
Corresponde a una extensión del modelo anterior pero considerando además una demora base por presencia de torniquete mariposa (todos los periodos).

$T = c + t_{L} \cdot L + t_{TRI} \cdot TRI + t_{s} \cdot S + \Big( t_{Y} + t_{Y}^{'} \cdot \gamma_{marip} + \Big(t_{Y}^{''} + t_{Y}^{'''} \cdot \gamma_{marip}  \Big) \cdot \gamma_{peak} \Big) \cdot Y + \Big( t_{I} + t_{I}^{'} \cdot \gamma_{peak} \Big) \cdot N_{I}$


```{r Modelo6, echo=FALSE}

#Creating dataframe
data.all <- data.frame(database$TEXP, 
                       database$largo_ruta, 
                       database$U_TRI, 
                       database$DET, 
                       database$Y,
                       database$Y_marip,
                       database$Y_peak,
                       database$Y_peak_marip,
                       database$NI, 
                       database$NI_peak)

names(data.all) <- c("texp",
                     "largo",
                     "TRI",
                     "DET",
                     "Y",
                     "Y_marip",
                     "Y_peak",
                     "Y_peak_marip",
                     "NI",
                     "NI_peak")

#Fitting the model
modelo_06 <- lm(as.formula("texp~."), data = data.all)
summary(modelo_06)

```


### Modelo 7

El Modelo 7 corresponde al Modelo 6, pero eliminando registros realizados por buses con torniquete de tres brazos.

$T = c + t_{L} \cdot L + t_{TRI} \cdot TRI + t_{s} \cdot S + \Big( t_{Y} + t_{Y}^{'} \cdot \gamma_{marip} + \Big(t_{Y}^{''} + t_{Y}^{'''} \cdot \gamma_{marip}  \Big) \cdot \gamma_{peak} \Big) \cdot Y + \Big( t_{I} + t_{I}^{'} \cdot \gamma_{peak} \Big) \cdot N_{I}$

```{r Modelo7, echo=FALSE}

#Creating dataframe
data.all <- data.frame(dataset$TEXP, 
                       dataset$largo_ruta, 
                       dataset$U_TRI, 
                       dataset$DET, 
                       dataset$Y,
                       dataset$Y_marip,
                       dataset$Y_peak,
                       dataset$Y_peak_marip,
                       dataset$NI, 
                       dataset$NI_peak)

names(data.all) <- c("texp",
                     "largo",
                     "TRI", 
                     "DET",
                     "Y",
                     "Y_marip", 
                     "Y_peak",
                     "Y_peak_marip",
                     "NI",
                     "NI_peak")

#Fitting the model
modelo_07 <- lm(as.formula("texp~."), data = data.all)
summary(modelo_07)

```


### Modelo 8

En lo sucesivo se estiman modelos sobre la base de registros realizados por buses que no cuentan con torniquete y buses que utilizan torniquete mariposa, es decir, se eliminan registros de buses con torniquete de tres brazos. El siguiente modelo es una extensión del anterior, pero considerando que el efecto del torniquete es apreciado solo en la puerta 1, y no en el resto, $i.e.$

$T = c + t_{L} \cdot L + t_{TRI} \cdot TRI + t_{s} \cdot S + \Big( t_{Y} + t_{Y}^{'} \cdot \gamma_{marip} + \Big(t_{Y}^{''} + t_{Y}^{'''} \cdot \gamma_{marip}  \Big) \cdot \gamma_{peak} \Big) \cdot Y_{P_{1}} + t_{Y}^{''''} \cdot Y_{resto} + \Big( t_{I} + t_{I}^{'} \cdot \gamma_{peak} \Big) \cdot N_{I}$

```{r Modelo8, echo=FALSE}

Y1 <- dataset$I.P1
Y1_marip <- dataset$I.P1 * dataset$turnstile_marip
Y1_peak <- dataset$I.P1 * dataset$Punta
Y1_peak_marip <- dataset$I.P1 * dataset$Punta * dataset$turnstile_marip
Y_resto <- dataset$I.P2 + dataset$I.P3 + dataset$I.P4

#Creating dataframe
data.all <- data.frame(dataset$TEXP, 
                       dataset$largo_ruta, 
                       dataset$U_TRI, 
                       dataset$DET, 
                       Y1,
                       Y1_marip,
                       Y1_peak,
                       Y1_peak_marip,
                       Y_resto,
                       dataset$NI, 
                       dataset$NI_peak)

names(data.all) <- c("texp",
                     "largo",
                     "TRI", 
                     "DET",
                     "Y1",
                     "Y1_marip", 
                     "Y1_peak",
                     "Y1_peak_marip",
                     "Y_resto",
                     "NI",
                     "NI_peak")


#Fitting the model
modelo_08 <- lm(as.formula("texp~."), data = data.all)
summary(modelo_08)

```

### Modelo 9

Corresponde al Modelo 8 pero agregando más demoras extras para la demanda que se sube por las puertas 2 a 4.

$T = c + t_{L} \cdot L + t_{TRI} \cdot TRI + t_{s} \cdot S + \Big( t_{Y} + t_{Y}^{'} \cdot \gamma_{marip} + \Big(t_{Y}^{''} + t_{Y}^{'''} \cdot \gamma_{marip}  \Big) \cdot \gamma_{peak} \Big) \cdot Y_{P_{1}} + \Big(t_{Y}^{''''} + t_{Y}^{'''''} \cdot \gamma_{peak} \Big) \cdot Y_{resto} + \Big( t_{I} + t_{I}^{'} \cdot \gamma_{peak} \Big) \cdot N_{I}$

```{r Modelo9, echo=FALSE}

Y1 <- dataset$I.P1
Y1_marip <- dataset$I.P1 * dataset$turnstile_marip
Y1_peak <- dataset$I.P1 * dataset$Punta
Y1_peak_marip <- dataset$I.P1 * dataset$Punta * dataset$turnstile_marip
Y_resto <- dataset$I.P2 + dataset$I.P3 + dataset$I.P4
Y_resto_peak <- Y_resto * dataset$Punta

#Creating dataframe
data.all <- data.frame(dataset$TEXP, 
                       dataset$largo_ruta, 
                       dataset$U_TRI, 
                       dataset$DET, 
                       Y1,
                       Y1_marip,
                       Y1_peak,
                       Y1_peak_marip,
                       Y_resto,
                       Y_resto_peak,
                       dataset$NI, 
                       dataset$NI_peak)

names(data.all) <- c("texp",
                     "largo",
                     "TRI", 
                     "DET",
                     "Y1",
                     "Y1_marip", 
                     "Y1_peak",
                     "Y1_peak_marip",
                     "Y_resto",
                     "Y_resto_peak",
                     "NI",
                     "NI_peak")


#Fitting the model
modelo_09 <- lm(as.formula("texp~."), data = data.all)
summary(modelo_09)


```

### Modelo 10

Se extiende el modelo anterior agregando una variable básica por uso de torniquete en las puertas 2 a 4, además de un tiempo extra por uso en periodos puntas, $i.e.$

$T = c + t_{L} \cdot L + t_{TRI} \cdot TRI + t_{s} \cdot S + \Big( t_{Y} + t_{Y}^{'} \cdot \gamma_{marip} + \Big(t_{Y}^{''} + t_{Y}^{'''} \cdot \gamma_{marip}  \Big) \cdot \gamma_{peak} \Big) \cdot Y_{P_{1}} + \Big(t_{Y}^{''''} + t_{Y}^{'''''} \cdot \gamma_{marip} + \Big( t_{Y}^{''''''} + t_{Y}^{'''''''} \cdot \gamma_{marip} \Big) \cdot \gamma_{peak} \Big) \cdot Y_{resto} + \Big( t_{I} + t_{I}^{'} \cdot \gamma_{peak} \Big) \cdot N_{I}$

```{r Modelo10, echo=FALSE}

Y1 <- dataset$I.P1
Y1_marip <- dataset$I.P1 * dataset$turnstile_marip
Y1_peak <- dataset$I.P1 * dataset$Punta
Y1_peak_marip <- dataset$I.P1 * dataset$Punta * dataset$turnstile_marip

Y_resto <- dataset$I.P2 + dataset$I.P3 + dataset$I.P4
Y_resto_peak <- Y_resto * dataset$Punta
Y_resto_marip <- Y_resto * dataset$turnstile_marip
Y_resto_peak_marip <- Y_resto * dataset$Punta * dataset$turnstile_marip

#Creating dataframe
data.all <- data.frame(dataset$TEXP, 
                       dataset$largo_ruta, 
                       dataset$U_TRI, 
                       dataset$DET, 
                       Y1,
                       Y1_marip,
                       Y1_peak,
                       Y1_peak_marip,
                       Y_resto,
                       Y_resto_marip,
                       Y_resto_peak,
                       Y_resto_peak_marip,
                       dataset$NI, 
                       dataset$NI_peak)

names(data.all) <- c("texp",
                     "largo",
                     "TRI", 
                     "DET",
                     "Y1",
                     "Y1_marip", 
                     "Y1_peak",
                     "Y1_peak_marip",
                     "Y_resto",
                     "Y_resto_marip",
                     "Y_resto_peak",
                     "Y_resto_peak_marip",
                     "NI",
                     "NI_peak")


#Fitting the model
modelo_10 <- lm(as.formula("texp~."), data = data.all)
summary(modelo_10)

```

Se desestima utilizar variables por uso de torniquete mariposa, por viaje en periodo punta y por uso de torniquete mariposa en periodo punta para aquella demanda que ingresa por las puertas 2 a 4. Esto se debe a que el torniquete es un impedimento físico que solo está presente en la primera puerta.

### Modelo 11

En este modelo se recogen los resultados obtenidos en los modelos anteriores, y se desagrega la demanda por aquella que ingresa en paradero normal y aquella que lo hace en zona paga, $i.e.$

$T = c + t_{L} \cdot L + t_{TRI} \cdot TRI + t_{s} \cdot S + \Big( t_{Y} + t_{Y}^{'} \cdot \gamma_{marip} + \Big(t_{Y}^{''} + t_{Y}^{'''} \cdot \gamma_{marip}  \Big) \cdot \gamma_{peak} \Big) \cdot Y_{PN_{1}} + \Big( t_{Y}^{''''} + t_{Y}^{'''''} \cdot \gamma_{marip} + \Big(t_{Y}^{''''''} + t_{Y}^{'''''''} \cdot \gamma_{marip}  \Big) \cdot \gamma_{peak} \Big) \cdot Y_{ZP_{1}} + t_{Y}^{''''} \cdot Y_{resto} + \Big( t_{I} + t_{I}^{'} \cdot \gamma_{peak} \Big) \cdot N_{I}$

```{r Modelo11, echo=FALSE}

Y_PN1 <- dataset$I.PN.P1
Y_PN1_marip <- dataset$I.PN.P1 * dataset$turnstile_marip
Y_PN1_peak <- dataset$I.PN.P1 * dataset$Punta
Y_PN1_peak_marip <- dataset$I.PN.P1 * dataset$Punta * dataset$turnstile_marip

Y_ZP1 <- dataset$I.ZP.P1
Y_ZP1_marip <- dataset$I.ZP.P1 * dataset$turnstile_marip
Y_ZP1_peak <- dataset$I.ZP.P1 * dataset$Punta
Y_ZP1_peak_marip <- dataset$I.ZP.P1 * dataset$Punta * dataset$turnstile_marip

Y_resto <- dataset$I.P2 + dataset$I.P3 + dataset$I.P4

#Creating dataframe
data.all <- data.frame(dataset$TEXP, 
                       dataset$largo_ruta, 
                       dataset$U_TRI, 
                       dataset$DET,
                       Y_PN1,
                       Y_PN1_marip,
                       Y_PN1_peak,
                       Y_PN1_peak_marip,
                       Y_ZP1,
                       Y_ZP1_marip,
                       Y_ZP1_peak,
                       Y_ZP1_peak_marip,
                       Y_resto,
                       dataset$NI, 
                       dataset$NI_peak)

names(data.all) <- c("texp",
                     "largo",
                     "TRI", 
                     "DET",
                     "Y_PN1",
                     "Y_PN1_marip", 
                     "Y_PN1_peak",
                     "Y_PN1_peak_marip",
                     "Y_ZP1",
                     "Y_ZP1_marip",
                     "Y_ZP1_peak",
                     "Y_ZP1_peak_marip",
                     "Y_resto",
                     "NI",
                     "NI_peak")


#Fitting the model
modelo_11 <- lm(as.formula("texp~."), data = data.all)
summary(modelo_11)

```

Los resultados anteriores dan cuenta del no uso de la puerta uno durante las subidas y bajadas cuando el bus cuanta con torniquete mariposa en zona paga, razón por la cual dicha variable es considerada estadísticamente no significativa. Además se observa el hecho de que existen personas que ingresan al bus a través de Zonas Pagas por las puertas 2, 3 y 4 (la mayoría), por lo que la modelación anterior no es necesariamente correcta.

### Modelo 12

Modelo anterior, pero eliminando variables estadísticamente no significativas.

```{r Modelo12, echo=FALSE}

Y_PN1 <- dataset$I.PN.P1
Y_PN1_marip <- dataset$I.PN.P1 * dataset$turnstile_marip
Y_PN1_peak <- dataset$I.PN.P1 * dataset$Punta
Y_PN1_peak_marip <- dataset$I.PN.P1 * dataset$Punta * dataset$turnstile_marip

Y_ZP1 <- dataset$I.ZP.P1
Y_ZP1_marip <- dataset$I.ZP.P1 * dataset$turnstile_marip
Y_ZP1_peak <- dataset$I.ZP.P1 * dataset$Punta
Y_ZP1_peak_marip <- dataset$I.ZP.P1 * dataset$Punta * dataset$turnstile_marip

Y_resto <- dataset$I.P2 + dataset$I.P3 + dataset$I.P4

#Creating dataframe
data.all <- data.frame(dataset$TEXP, 
                       dataset$largo_ruta, 
                       dataset$U_TRI, 
                       dataset$DET,
                       
                       Y_PN1,
                       Y_PN1_marip,
                       Y_PN1_peak,
                       Y_PN1_peak_marip,
                       
                       Y_ZP1,
                       
                       Y_resto,
                       dataset$NI, 
                       dataset$NI_peak)

names(data.all) <- c("texp",
                     "largo",
                     "TRI", 
                     "DET",
                     
                     "Y_PN1",
                     "Y_PN1_marip", 
                     "Y_PN1_peak",
                     "Y_PN1_peak_marip",
                     
                     "Y_ZP1",
                     
                     "Y_resto",
                     "NI",
                     "NI_peak")


#Fitting the model
modelo_12 <- lm(as.formula("texp~."), data = data.all)
summary(modelo_12)

```


### Modelo 13

Este modelo es una extensión del modelo anterior. En particular se prueba la significancia del uso de torniquete mariposa cuando se ingresa al bus a través de una ZP.

$T = c + t_{L} \cdot L + t_{TRI} \cdot TRI + t_{s} \cdot S + \Big( t_{Y} + t_{Y}^{'} \cdot \gamma_{marip} + \Big(t_{Y}^{''} + t_{Y}^{'''} \cdot \gamma_{marip}  \Big) \cdot \gamma_{peak} \Big) \cdot Y_{PN_{1}} + \Big( t_{Y}^{''''} + t_{Y}^{'''''} \cdot \gamma_{marip} \Big) \cdot Y_{ZP_{1}} + t_{Y}^{''''} \cdot Y_{resto} + \Big( t_{I} + t_{I}^{'} \cdot \gamma_{peak} \Big) \cdot N_{I}$

```{r Modelo13, echo=FALSE}

Y_PN1 <- dataset$I.PN.P1
Y_PN1_marip <- dataset$I.PN.P1 * dataset$turnstile_marip
Y_PN1_peak <- dataset$I.PN.P1 * dataset$Punta
Y_PN1_peak_marip <- dataset$I.PN.P1 * dataset$Punta * dataset$turnstile_marip

Y_ZP1 <- dataset$I.ZP.P1
Y_ZP1_marip <- dataset$I.ZP.P1 * dataset$turnstile_marip
Y_ZP1_peak <- dataset$I.ZP.P1 * dataset$Punta
Y_ZP1_peak_marip <- dataset$I.ZP.P1 * dataset$Punta * dataset$turnstile_marip

Y_resto <- dataset$I.P2 + dataset$I.P3 + dataset$I.P4

#Creating dataframe
data.all <- data.frame(dataset$TEXP, 
                       dataset$largo_ruta, 
                       dataset$U_TRI, 
                       dataset$DET,
                       
                       Y_PN1,
                       Y_PN1_marip,
                       Y_PN1_peak,
                       Y_PN1_peak_marip,
                       
                       Y_ZP1,
                       Y_ZP1_marip,
                       
                       Y_resto,
                       dataset$NI, 
                       dataset$NI_peak)

names(data.all) <- c("texp",
                     "largo",
                     "TRI", 
                     "DET",
                     
                     "Y_PN1",
                     "Y_PN1_marip", 
                     "Y_PN1_peak",
                     "Y_PN1_peak_marip",
                     
                     "Y_ZP1",
                     "Y_ZP1_marip",
                     
                     "Y_resto",
                     "NI",
                     "NI_peak")


#Fitting the model
modelo_13 <- lm(as.formula("texp~."), data = data.all)
summary(modelo_13)

```

Variable del uso de torniquete mariposa por la puerta 1 cuando se ingresa al bus a través de ZP, es estadísticamente no significativa, dando cuenta del no uso de esta puerta en dichas condiciones. El modelo anterior sigue teniendo un problema de modelación. En $Y_{resto}$ se tiene la demanda que ingresa por las puertas 2 a 4, la que es esencialmente ZP y que no está siendo considerada en la variable asociada a este fenómeno, razón por la que se modela la demanda restante entre aquella que lo hace por paradero normal y aquellos que ingresan al bus a través de ZP.

#### Modelo 14

Modelo anterior, pero desagregando la demanda restante en aquella que ingresa por paradero normal y zona paga.

$T = c + t_{L} \cdot L + t_{TRI} \cdot TRI + t_{s} \cdot S + \Big( t_{Y} + t_{Y}^{'} \cdot \gamma_{marip} + \Big(t_{Y}^{''} + t_{Y}^{'''} \cdot \gamma_{marip}  \Big) \cdot \gamma_{peak} \Big) \cdot Y_{PN_{1}} + t_{Y}^{''''} \cdot Y_{PN} + t_{Y}^{'''''} \cdot Y_{ZP} + \Big( t_{I} + t_{I}^{'} \cdot \gamma_{peak} \Big) \cdot N_{I}$

```{r Modelo14, echo=FALSE}

Y_PN1 <- dataset$I.PN.P1
Y_PN1_marip <- dataset$I.PN.P1 * dataset$turnstile_marip
Y_PN1_peak <- dataset$I.PN.P1 * dataset$Punta
Y_PN1_peak_marip <- dataset$I.PN.P1 * dataset$Punta * dataset$turnstile_marip

Y_PN_resto <- dataset$I.PN.P2 + dataset$I.PN.P3 + dataset$I.PN.P4
Y_ZP <- dataset$I.ZP.P1 + dataset$I.ZP.P2 + dataset$I.ZP.P3 + dataset$I.ZP.P4

#Creating dataframe
data.all <- data.frame(dataset$TEXP, 
                       dataset$largo_ruta, 
                       dataset$U_TRI, 
                       dataset$DET,
                       Y_PN1,
                       Y_PN1_marip,
                       Y_PN1_peak,
                       Y_PN1_peak_marip,
                       Y_PN_resto,
                       Y_ZP,
                       dataset$NI, 
                       dataset$NI_peak)

names(data.all) <- c("texp",
                     "largo",
                     "TRI", 
                     "DET",
                     
                     "Y_PN_P1",
                     "Y_PN_P1_marip", 
                     "Y_PN_P1_peak",
                     "Y_PN_P1_peak_marip",
                     
                     "Y_PN",
                     "Y_ZP",
                     
                     "NI",
                     "NI_peak")


#Fitting the model
modelo_14 <- lm(as.formula("texp~."), data = data.all)
summary(modelo_14)
plot(modelo_14)

predicted <- predict(modelo_14, data.all[,-1])
#pdf(file = "actual_predicted.pdf",7,5)
plot(x= data.all$texp, y=predicted,
     main = "Predicted vs. Actual values",
     xlab = "Actual",
     ylab = "Predicted")
abline(0,1, col="red")
#dev.off()

```


```{r}

#OFF PEAK S/TORNIQUETE
demanda <- 200
peak <- rep(1,demanda)
mariposa <-  rep(0,demanda)

largo <- rep(21.89,demanda)
TRI <- rep(8,demanda)
DET <- rep(43,demanda)
Y_PN_P1 <- seq(1,demanda,by=1)

Y_PN <- rep(mean(dataset$I.PN.P2[which(dataset$SERVICIO=="F06" & dataset$Sentido=="Regreso")] +
  dataset$I.PN.P3[which(dataset$SERVICIO=="F06" & dataset$Sentido=="Regreso")] +
  dataset$I.PN.P4[which(dataset$SERVICIO=="F06" & dataset$Sentido=="Regreso")]),demanda)


Y_ZP <- rep(mean(dataset$I.ZP.P1[which(dataset$SERVICIO=="F06" & dataset$Sentido=="Regreso")] + 
  dataset$I.ZP.P2[which(dataset$SERVICIO=="F06" & dataset$Sentido=="Regreso")] + 
  dataset$I.ZP.P3[which(dataset$SERVICIO=="F06" & dataset$Sentido=="Regreso")] +
  dataset$I.ZP.P4[which(dataset$SERVICIO=="F06" & dataset$Sentido=="Regreso")]),demanda)



Y_PN_P1_peak <- Y_PN_P1 * peak
Y_PN_P1_marip <- Y_PN_P1 * mariposa
Y_PN_P1_peak_marip <- Y_PN_P1 * peak * mariposa

NI <- rep(31,demanda)
NI_peak <- NI * peak



F06 <- data.frame(largo,
                  TRI,
                  DET,
                  Y_PN_P1,
                  Y_PN_P1_marip,
                  Y_PN_P1_peak,
                  Y_PN_P1_peak_marip,
                  Y_PN,
                  Y_ZP,
                  NI,
                  NI_peak)

predicted <- predict(modelo_14, F06)
F06$pred <- predicted


Tiempos <- data.frame(F06$Y_PN_P1,F06$pred)
names(Tiempos) <- c("Demanda","S/T")



#OFF PEAK C/TORNIQUETE
demanda <- 200
peak <- rep(1,demanda)
mariposa <-  rep(1,demanda)

largo <- rep(21.89,demanda)
TRI <- rep(8,demanda)
DET <- rep(43,demanda)
Y_PN_P1 <- seq(1,demanda,by=1)

Y_PN <- rep(mean(dataset$I.PN.P2[which(dataset$SERVICIO=="F06" & dataset$Sentido=="Regreso")] +
  dataset$I.PN.P3[which(dataset$SERVICIO=="F06" & dataset$Sentido=="Regreso")] +
  dataset$I.PN.P4[which(dataset$SERVICIO=="F06" & dataset$Sentido=="Regreso")]),demanda)


Y_ZP <- rep(mean(dataset$I.ZP.P1[which(dataset$SERVICIO=="F06" & dataset$Sentido=="Regreso")] + 
  dataset$I.ZP.P2[which(dataset$SERVICIO=="F06" & dataset$Sentido=="Regreso")] + 
  dataset$I.ZP.P3[which(dataset$SERVICIO=="F06" & dataset$Sentido=="Regreso")] +
  dataset$I.ZP.P4[which(dataset$SERVICIO=="F06" & dataset$Sentido=="Regreso")]),demanda)



Y_PN_P1_peak <- Y_PN_P1 * peak
Y_PN_P1_marip <- Y_PN_P1 * mariposa
Y_PN_P1_peak_marip <- Y_PN_P1 * peak * mariposa

NI <- rep(31,demanda)
NI_peak <- NI * peak



F06 <- data.frame(largo,
                  TRI,
                  DET,
                  Y_PN_P1,
                  Y_PN_P1_marip,
                  Y_PN_P1_peak,
                  Y_PN_P1_peak_marip,
                  Y_PN,
                  Y_ZP,
                  NI,
                  NI_peak)

predicted <- predict(modelo_14, F06)

Tiempos <- cbind(Tiempos, predicted)
names(Tiempos)[3] <- "C/T" 


pdf(file = "texp_F06R_peak.pdf",7,5)
ggplot(Tiempos) +
  geom_line(aes(x=Tiempos$Demanda, y=Tiempos$`S/T`), col="blue") + 
  geom_line(aes(x=Tiempos$Demanda, y=Tiempos$`C/T`), col="red") +
  labs(x="Demanda PN Puerta 1 (pax)",
       y="Tiempo de expedición (s)") +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5)) +
  ggtitle("Tiempo de Expedición F06R, Peak") +
  scale_y_continuous(limits = c(3750, 6000))
dev.off()
getwd()



```




















A continuación se estiman los tiempos de viaje del dataset utilizado, pero considerando el opuesto al uso o no uso de torniquete mariposa y manteniendo el resto de las variables constantes.

```{r Output analysis, echo=FALSE}

torniquete <- rep(0,nrow(dataset))
torniquete[which(dataset$turnstile_marip == 1)] <- "SI"
torniquete[which(dataset$n_turnstile==1)] <- "NO"

#Creando variables de demanda
Y_PN1 <- dataset$I.PN.P1
Y_PN1_marip <- dataset$I.PN.P1 * dataset$n_turnstile
Y_PN1_peak <- dataset$I.PN.P1 * dataset$Punta
Y_PN1_peak_marip <- dataset$I.PN.P1 * dataset$Punta * dataset$n_turnstile

Y_PN_resto <- dataset$I.PN.P2 + dataset$I.PN.P3 + dataset$I.PN.P4
Y_ZP <- dataset$I.ZP.P1 + dataset$I.ZP.P2 + dataset$I.ZP.P3 + dataset$I.ZP.P4

#Creating dataframe
data.all <- data.frame(dataset$TEXP,
                       dataset$largo_ruta, 
                       dataset$U_TRI, 
                       dataset$DET,
                       Y_PN1,
                       Y_PN1_marip,
                       Y_PN1_peak,
                       Y_PN1_peak_marip,
                       Y_PN_resto,
                       Y_ZP,
                       dataset$NI, 
                       dataset$NI_peak)

names(data.all) <- c("texp",
                     "largo",
                     "TRI", 
                     "DET",
                     
                     "Y_PN_P1",
                     "Y_PN_P1_marip", 
                     "Y_PN_P1_peak",
                     "Y_PN_P1_peak_marip",
                     
                     "Y_PN",
                     "Y_ZP",
                     
                     "NI",
                     "NI_peak")

Pred_Inv <- predict(modelo_14, data.all[,-1])
data.all$Y <- dataset$Y
data.all$EV <- dataset$EV
data.all$TOR <- torniquete
data.all$Peak <- dataset$Punta
data.all$Predicted <- predicted
data.all$Pred_Inv <- Pred_Inv
data.all$Delta <- ((data.all$Pred_Inv - data.all$Predicted)/data.all$Predicted)*100
data.all$Delta_Act <- ((data.all$Pred_Inv - data.all$texp)/data.all$texp)*100
data.all <- data.all[-which(data.all$TOR=="SI"),]


```


#### Modelo 15

El modelo a continuación es simple y solo desagrega la demanda en aquella que ingresa por paradero normal y aquella que lo hace por zona paga, con el fin de conocer los tiempos promedios de subida y bajada en cada caso, $i.e.$

$T = c + t_{L} \cdot L + t_{s} \cdot S +  t_{Y} \cdot Y_{PN}  + t_{Y}^{'} \cdot Y_{ZP} + \Big( t_{I} + t_{I}^{'} \cdot \gamma_{peak} \Big) \cdot N_{I}$


```{r Modelo15, echo=FALSE}
data.all <- data.frame(dataset$TEXP, 
                       dataset$largo_ruta, 
                       dataset$DET, 
                       dataset$I.PN,
                       dataset$I.ZP,
                       dataset$NI,
                       dataset$NI_peak)


names(data.all) <- c("texp",
                     "largo",
                     "det",
                     "Y_PN",
                     "Y_ZP",
                     "NI",
                     "NI_peak")

modelo_15 <- lm(as.formula("texp~."), data = data.all)
summary(modelo_15)
```


### Modelo 16

En el modelo siguiente se ajusta un Modelo 14 pero solo en aquellos recorridos que fueron editados en su número de intersecciones semaforizadas, y por tanto existe una mayor seguridad de su valor.

$T = c + t_{L} \cdot L + t_{TRI} \cdot TRI + t_{s} \cdot S + \Big( t_{Y} + t_{Y}^{'} \cdot \gamma_{marip} + \Big(t_{Y}^{''} + t_{Y}^{'''} \cdot \gamma_{marip}  \Big) \cdot \gamma_{peak} \Big) \cdot Y_{PN_{1}} + \Big( t_{Y}^{''''} + t_{Y}^{'''''} \cdot \gamma_{marip} \Big) \cdot Y_{ZP_{1}} + t_{Y}^{''''} \cdot Y_{resto} + \Big( t_{I} + t_{I}^{'} \cdot \gamma_{peak} \Big) \cdot N_{I}$

```{r Modelo16, echo=FALSE}

#Setting working space
setwd("/Users/diego/Desktop/Evasion/01_analisis/03_datos/04_NI/")
servicios_subset <- read.csv(file = "recorridos_editado.csv", header = TRUE, sep = ";")

servicios_subset$Editados <- gsub(" ","",servicios_subset$Editados)
servicios_subset$Editados <- toupper(servicios_subset$Editados)

#Getting routes subset
dataset <- dataset[which(dataset$ROUTE_NAME %in% servicios_subset$Editados),]


Y_PN1 <- dataset$I.PN.P1
Y_PN1_marip <- dataset$I.PN.P1 * dataset$turnstile_marip
Y_PN1_peak <- dataset$I.PN.P1 * dataset$Punta
Y_PN1_peak_marip <- dataset$I.PN.P1 * dataset$Punta * dataset$turnstile_marip

Y_PN_resto <- dataset$I.PN.P2 + dataset$I.PN.P3 + dataset$I.PN.P4
Y_ZP <- dataset$I.ZP.P1 + dataset$I.ZP.P2 + dataset$I.ZP.P3 + dataset$I.ZP.P4

#Creating dataframe
data.all <- data.frame(dataset$TEXP, 
                       dataset$largo_ruta, 
                       dataset$U_TRI, 
                       dataset$DET,
                       Y_PN1,
                       Y_PN1_marip,
                       Y_PN1_peak,
                       Y_PN1_peak_marip,
                       Y_PN_resto,
                       Y_ZP,
                       dataset$NI, 
                       dataset$NI_peak)

names(data.all) <- c("texp",
                     "largo",
                     "TRI", 
                     "DET",
                     
                     "Y_PN_P1",
                     "Y_PN_P1_marip", 
                     "Y_PN_P1_peak",
                     "Y_PN_P1_peak_marip",
                     
                     "Y_PN",
                     "Y_ZP",
                     
                     "NI",
                     "NI_peak")

#Original database
dataset <- dataset_original


#Fitting the model
modelo_16 <- lm(as.formula("texp~."), data = data.all)
summary(modelo_16)


```

### Modelo 17

El siguiente modelo es un intento por determinar el impacto que tienen relaciones cuadráticas de la demanda (si las hubiere) en los tiempos de viaje y el uso de torniquete mariposa.

```{r Modelo17, echo=FALSE}

Y_PN1 <- dataset$I.PN.P1
Y_PN1_2 <- dataset$I.PN.P1 * dataset$I.PN.P1
Y_PN1_2_marip <- dataset$I.PN.P1 * dataset$I.PN.P1 * dataset$turnstile_marip


Y_PN_resto <- dataset$I.PN.P2 + dataset$I.PN.P3 + dataset$I.PN.P4
Y_ZP <- dataset$I.ZP.P1 + dataset$I.ZP.P2 + dataset$I.ZP.P3 + dataset$I.ZP.P4

#Creating dataframe
data.all <- data.frame(dataset$TEXP, 
                       dataset$largo_ruta, 
                       dataset$U_TRI, 
                       dataset$DET,
                       
                       Y_PN1,
                       Y_PN1_2,
                       Y_PN1_2_marip,
                       
                       Y_PN_resto,
                       Y_ZP,
                       dataset$NI, 
                       dataset$NI_peak)

names(data.all) <- c("texp",
                     "largo",
                     "TRI", 
                     "DET",
                     
                     "Y_PN_P1",
                     "Y_PN_P1^2", 
                     "Y_PN_P1^2_marip",
                     
                     "Y_PN",
                     "Y_ZP",
                     
                     "NI",
                     "NI_peak")


#Fitting the model
modelo_17 <- lm(as.formula("texp~."), data = data.all)
summary(modelo_17)

```

### Modelo 18

En este modelo se prueba el Modelo 14, pero en toda la base de datos, es decir, incorporando y controlando por el efecto de expediciones realizadas en buses con torniquete de tres brazos, tanto en periodos fuera de punta como periodos punta, $i.e.$

$T = c + t_{L} \cdot L + t_{TRI} \cdot TRI + t_{s} \cdot S + \Big( t_{Y} + t_{Y}^{'} \cdot \gamma_{marip} + t_{Y}^{''} \cdot \gamma_{3B} + \Big(t_{Y}^{'''} + t_{Y}^{''''} \cdot \gamma_{marip} + t_{Y}^{'''''} \cdot \gamma_{3B} \Big) \cdot \gamma_{peak} \Big) \cdot Y_{PN_{1}} + t_{Y}^{''''''} \cdot Y_{PN} + t_{Y}^{'''''''} \cdot Y_{ZP} + \Big( t_{I} + t_{I}^{'} \cdot \gamma_{peak} \Big) \cdot N_{I}$

```{r}

Y_PN1 <- database$I.PN.P1
Y_PN1_marip <- database$I.PN.P1 * database$turnstile_marip
Y_PN1_3B <- database$I.PN.P1 * database$turnstile_3b
Y_PN1_peak <- database$I.PN.P1 * database$Punta
Y_PN1_peak_marip <- database$I.PN.P1 * database$Punta * database$turnstile_marip
Y_PN1_peak_3B <- database$I.PN.P1 * database$Punta * database$turnstile_3b

Y_PN_resto <- database$I.PN.P2 + database$I.PN.P3 + database$I.PN.P4
Y_ZP <- database$I.ZP.P1 + database$I.ZP.P2 + database$I.ZP.P3 + database$I.ZP.P4

#Creating dataframe
data.all <- data.frame(database$TEXP, 
                       database$largo_ruta, 
                       database$U_TRI, 
                       database$DET,
                       Y_PN1,
                       Y_PN1_marip,
                       Y_PN1_3B,
                       Y_PN1_peak,
                       Y_PN1_peak_marip,
                       Y_PN1_peak_3B,
                       Y_PN_resto,
                       Y_ZP,
                       database$NI, 
                       database$NI_peak)

names(data.all) <- c("texp",
                     "largo",
                     "TRI", 
                     "DET",
                     
                     "Y_PN_P1",
                     "Y_PN_P1_marip",
                     "Y_PN_P1_3B",
                     "Y_PN_P1_peak",
                     "Y_PN_P1_peak_marip",
                     "Y_PN_P1_peak_3B",
                     
                     "Y_PN",
                     "Y_ZP",
                     
                     "NI",
                     "NI_peak")


#Fitting the model
modelo_18 <- lm(as.formula("texp~."), data = data.all)
summary(modelo_18)
```

Debido a algunos resultados inconsistentes de este modelo en los valores de los coeficientes asociados a los torniquetes de 3B, se utilizan dummies para las detenciones específicas para cada unidad de negocio.


### Modelo 19

El siguiente modelo, corresponde a una extensión del modelo anterior, pero considerando variables extras de detenciones dependiendo de la unidad de negocio, considerando U5 como base, $i.e.$

$T = c + t_{L} \cdot L + t_{TRI} \cdot TRI + t_{s}  \cdot S + \sum_{U-U5} t_{s}^{U} \cdot S \cdot \gamma_{U} + \Big( t_{Y} + t_{Y}^{'} \cdot \gamma_{marip} + t_{Y}^{''} \cdot \gamma_{3B} + \Big(t_{Y}^{'''} + t_{Y}^{''''} \cdot \gamma_{marip} + t_{Y}^{'''''} \cdot \gamma_{3B} \Big) \cdot \gamma_{peak} \Big) \cdot Y_{PN_{1}} + t_{Y}^{''''''} \cdot Y_{PN} + t_{Y}^{'''''''} \cdot Y_{ZP} + \Big( t_{I} + t_{I}^{'} \cdot \gamma_{peak} \Big) \cdot N_{I}$

```{r Modelo19, echo=FALSE}

Y_PN1 <- database$I.PN.P1
Y_PN1_marip <- database$I.PN.P1 * database$turnstile_marip
Y_PN1_3B <- database$I.PN.P1 * database$turnstile_3b
Y_PN1_peak <- database$I.PN.P1 * database$Punta
Y_PN1_peak_marip <- database$I.PN.P1 * database$Punta * database$turnstile_marip
Y_PN1_peak_3B <- database$I.PN.P1 * database$Punta * database$turnstile_3b

Y_PN_resto <- database$I.PN.P2 + database$I.PN.P3 + database$I.PN.P4
Y_ZP <- database$I.ZP.P1 + database$I.ZP.P2 + database$I.ZP.P3 + database$I.ZP.P4

#Detenciones especiales por unidad (Se utiliza U5 como base)
DET_U1 <- database$DET * database$U1
DET_U2 <- database$DET * database$U2
DET_U3 <- database$DET * database$U3
DET_U4 <- database$DET * database$U4
DET_U5 <- database$DET * database$U5
DET_U6 <- database$DET * database$U6
DET_U7 <- database$DET * database$U7

#Creating dataframe
data.all <- data.frame(database$TEXP, 
                       database$largo_ruta, 
                       database$U_TRI, 
                       database$DET,
                       DET_U1,
                       DET_U2,
                       DET_U3,
                       DET_U4,
                       DET_U6,
                       DET_U7,
                       Y_PN1,
                       Y_PN1_marip,
                       Y_PN1_3B,
                       Y_PN1_peak,
                       Y_PN1_peak_marip,
                       Y_PN1_peak_3B,
                       Y_PN_resto,
                       Y_ZP,
                       database$NI, 
                       database$NI_peak)

names(data.all) <- c("texp",
                     "largo",
                     "TRI", 
                     "DET",
                     "DET_U1",
                     "DET_U2",
                     "DET_U3",
                     "DET_U4",
                     "DET_U6",
                     "DET_U7",
                     
                     "Y_PN_P1",
                     "Y_PN_P1_marip",
                     "Y_PN_P1_3B",
                     "Y_PN_P1_peak",
                     "Y_PN_P1_peak_marip",
                     "Y_PN_P1_peak_3B",
                     
                     "Y_PN",
                     "Y_ZP",
                     
                     "NI",
                     "NI_peak")


#Fitting the model
modelo_19 <- lm(as.formula("texp~."), data = data.all)
summary(modelo_19)
```

### Modelo 20

Se eliminan variables estadísticamente no significativas el modelo queda de la siguiente forma:


$T = c + t_{L} \cdot L + t_{TRI} \cdot TRI + t_{s}  \cdot S + \sum_{U-(U5,U6)} t_{s}^{U} \cdot S \cdot \gamma^{U} + \Big( t_{Y} + t_{Y}^{'} \cdot \gamma_{marip} + \Big(t_{Y}^{'''} + t_{Y}^{''''} \cdot \gamma_{marip} + t_{Y}^{'''''} \cdot \gamma_{3B} \Big) \cdot \gamma_{peak} \Big) \cdot Y_{PN_{1}} + t_{Y}^{''''''} \cdot Y_{PN} + t_{Y}^{'''''''} \cdot Y_{ZP} + \Big( t_{I} + t_{I}^{'} \cdot \gamma_{peak} \Big) \cdot N_{I}$

```{r Modelo20, echo=FALSE}
Y_PN1 <- database$I.PN.P1
Y_PN1_marip <- database$I.PN.P1 * database$turnstile_marip
Y_PN1_3B <- database$I.PN.P1 * database$turnstile_3b
Y_PN1_peak <- database$I.PN.P1 * database$Punta
Y_PN1_peak_marip <- database$I.PN.P1 * database$Punta * database$turnstile_marip
Y_PN1_peak_3B <- database$I.PN.P1 * database$Punta * database$turnstile_3b

Y_PN_resto <- database$I.PN.P2 + database$I.PN.P3 + database$I.PN.P4
Y_ZP <- database$I.ZP.P1 + database$I.ZP.P2 + database$I.ZP.P3 + database$I.ZP.P4

#Detenciones especiales por unidad (Se utiliza U5 como base)
DET_U1 <- database$DET * database$U1
DET_U2 <- database$DET * database$U2
DET_U3 <- database$DET * database$U3
DET_U4 <- database$DET * database$U4
DET_U5 <- database$DET * database$U5
DET_U6 <- database$DET * database$U6
DET_U7 <- database$DET * database$U7

#Creating dataframe
data.all <- data.frame(database$TEXP, 
                       database$largo_ruta, 
                       database$U_TRI, 
                       database$DET,
                       DET_U1,
                       DET_U2,
                       DET_U3,
                       DET_U4,
                       DET_U7,
                       Y_PN1,
                       Y_PN1_marip,
                       Y_PN1_peak,
                       Y_PN1_peak_marip,
                       Y_PN1_peak_3B,
                       Y_PN_resto,
                       Y_ZP,
                       database$NI, 
                       database$NI_peak)

names(data.all) <- c("texp",
                     "largo",
                     "TRI", 
                     "DET",
                     "DET_U1",
                     "DET_U2",
                     "DET_U3",
                     "DET_U4",
                     "DET_U7",
                     
                     "Y_PN_P1",
                     "Y_PN_P1_marip",
                     "Y_PN_P1_peak",
                     "Y_PN_P1_peak_marip",
                     "Y_PN_P1_peak_3B",
                     
                     "Y_PN",
                     "Y_ZP",
                     
                     "NI",
                     "NI_peak")


#Fitting the model
modelo_20 <- lm(as.formula("texp~."), data = data.all)
summary(modelo_20)
```

### Modelo 21

Se prueba nuevamente, en el modelo anterior, la significancia del uso de torniquete de tres brazos durante periodos fuera de punta, $i.e.$

$T = c + t_{L} \cdot L + t_{TRI} \cdot TRI + t_{s}  \cdot S + \sum_{U-(U5,U6)} t_{s}^{U} \cdot S \cdot \gamma^{U} + \Big( t_{Y} + t_{Y}^{'} \cdot \gamma_{marip} + t_{Y}^{''} \cdot \gamma_{3B} + \Big(t_{Y}^{'''} + t_{Y}^{''''} \cdot \gamma_{marip} + t_{Y}^{'''''} \cdot \gamma_{3B} \Big) \cdot \gamma_{peak} \Big) \cdot Y_{PN_{1}} + t_{Y}^{''''''} \cdot Y_{PN} + t_{Y}^{'''''''} \cdot Y_{ZP} + \Big( t_{I} + t_{I}^{'} \cdot \gamma_{peak} \Big) \cdot N_{I}$

```{r Modelo21, echo=FALSE}

Y_PN1 <- database$I.PN.P1
Y_PN1_marip <- database$I.PN.P1 * database$turnstile_marip
Y_PN1_3B <- database$I.PN.P1 * database$turnstile_3b
Y_PN1_peak <- database$I.PN.P1 * database$Punta
Y_PN1_peak_marip <- database$I.PN.P1 * database$Punta * database$turnstile_marip
Y_PN1_peak_3B <- database$I.PN.P1 * database$Punta * database$turnstile_3b

Y_PN_resto <- database$I.PN.P2 + database$I.PN.P3 + database$I.PN.P4
Y_ZP <- database$I.ZP.P1 + database$I.ZP.P2 + database$I.ZP.P3 + database$I.ZP.P4

#Detenciones especiales de U2
DET_U1 <- database$DET * database$U1
DET_U2 <- database$DET * database$U2
DET_U3 <- database$DET * database$U3
DET_U4 <- database$DET * database$U4
DET_U5 <- database$DET * database$U5
DET_U6 <- database$DET * database$U6
DET_U7 <- database$DET * database$U7


#Creating dataframe
data.all <- data.frame(database$TEXP, 
                       database$largo_ruta, 
                       database$U_TRI, 
                       database$DET,
                       DET_U1,
                       DET_U2,
                       DET_U3,
                       DET_U4,
                       DET_U7,
                       
                       Y_PN1,
                       Y_PN1_marip,
                       Y_PN1_3B,
                       Y_PN1_peak,
                       Y_PN1_peak_marip,
                       Y_PN1_peak_3B,
                       
                       Y_PN_resto,
                       Y_ZP,
                       
                       database$NI, 
                       database$NI_peak)

names(data.all) <- c("texp",
                     "largo",
                     "TRI", 
                     "DET",
                     "DET_U1",
                     "DET_U2",
                     "DET_U3",
                     "DET_U4",
                     "DET_U7",
                     
                     "Y_PN_P1",
                     "Y_PN_P1_marip",
                     "Y_PN_P1_3B",
                     "Y_PN_P1_peak",
                     "Y_PN_P1_peak_marip",
                     "Y_PN_P1_peak_3B",
                     
                     "Y_PN",
                     "Y_ZP",
                     
                     "NI",
                     "NI_peak")


#Fitting the model
modelo_21 <- lm(as.formula("texp~."), data = data.all)
summary(modelo_21)
```

Variable asociada al uso de torniquete de tres brazos durante periodo fuera de punta sigue siendo estadísticamente no significativa en comparación al no uso de torniquete. Por su parte, valores asociados a coeficientes de uso de torniquete de tres brazos no son consistentes, observando valores menores de tiempos promedios de subidas y bajadas por pasajero en presencia de torniquete de este tipo, versus el no uso de torniquete. Por esta razón se decide seguir estimando modelos solo con la base de existencia de torniquete mariposa.


















































<!-- ## Especificación Peak por Demanda -->

<!-- En los modelos anteriores se ha utilizado como especificación de los periodos más demandados el horario definido por Transantiago, sin embargo la estructura de la demanda puede ser distinta por recorridos. Por esta razón se utilizará una especificación distinta, y se hará en función de la demanda y no del horario de viaje. -->

<!-- En los siguientes modelos se asumirá un número de personas que ingresan por paradero al bus sin afectar el tiempo de viaje, es decir, que el bus cierra sus puertas y parte independiente de que dicho número de personas aún no haya pasado a través del torniquete mariposa. -->

<!-- ### Modelo 18 (X=2) -->

<!-- El primer modelo es el Modelo 14, pero asumiendo un valor de X = 2, es decir, es a partir del segundo pasajero que sube al bus por paradero donde el efecto del torniquete mariposa en los tiempos de viaje es evidenciable, $i.e.$ -->

<!-- $T = c + t_{L} \cdot L + t_{TRI} \cdot TRI + t_{s} \cdot S + t_{Y} \cdot Y_{PN_{1}} + \Big( t_{Y}^{'} + t_{Y}^{''} \cdot \gamma_{marip} \Big) \cdot Y_{rmte_{PN1}} + t_{Y}^{'''} \cdot Y_{PN} + t_{Y}^{''''} \cdot Y_{ZP} + \Big( t_{I} + t_{I}^{'} \cdot \gamma_{peak} \Big) \cdot N_{I}$ -->

<!-- ```{r Modelo18, echo=FALSE} -->

<!-- ############################################################################# -->
<!-- #Setting working directory -->
<!-- setwd("/Users/diego/Desktop/Evasion/01_analisis/03_datos/12_Bases_modelo/") -->

<!-- #Reading input files -->
<!-- database <- read.csv(file = "data_modelo_X2.csv", header = TRUE, sep = ";") -->

<!-- #Cambiando unidad de medida de largo del recorrido (Kms.) -->
<!-- database$largo_ruta <- database$largo_ruta/1000 -->

<!-- #One hot encoding for periods of time -->
<!-- periodos <- as.data.frame(model.matrix(~database$Periodo-1)) -->
<!-- names(periodos) <- sprintf("P%s",3:10) -->
<!-- periodo_punta <- periodos$P4 + periodos$P9 -->

<!-- database <- cbind(database, periodos) -->
<!-- database$Punta <- periodo_punta -->

<!-- #NI peak -->
<!-- database$NI_peak <- database$NI * periodo_punta -->

<!-- #Demanda en periodo punta -->
<!-- database$Y_peak <- database$Y * periodo_punta -->

<!-- #Agregando trimestre único -->
<!-- database$U_TRI <- database$TRI -->
<!-- database$U_TRI[which(substr(database$FECHA,1,4) == "2017" & database$TRI == 1)] <- 5 -->
<!-- database$U_TRI[which(substr(database$FECHA,1,4) == "2017" & database$TRI == 2)] <- 6 -->
<!-- database$U_TRI[which(substr(database$FECHA,1,4) == "2017" & database$TRI == 3)] <- 7 -->
<!-- database$U_TRI[which(substr(database$FECHA,1,4) == "2017" & database$TRI == 4)] <- 8 -->

<!-- #Variable por presencia de torniquete de tres brazos -->
<!-- database$turnstile_3b <- 0 -->
<!-- database$turnstile_3b[which(database$turnstile==1 & database$turnstile_marip==0)] <- 1 -->

<!-- #Demanda con torniquete mariposa y de trez brazos en periodos punta. -->
<!-- database$Y_peak_marip <- database$Y * periodo_punta * database$turnstile_marip -->
<!-- database$Y_peak_3b <- database$Y * periodo_punta * database$turnstile_3b -->

<!-- #Demanda con torniquete mariposa y torniquete de tres brazos. -->
<!-- database$Y_marip <- database$Y * database$turnstile_marip -->
<!-- database$Y_3b <- database$Y * database$turnstile_3b -->


<!-- #Se construye un dataset sin considerar torniquete de tres brazos -->
<!-- dataset <- database[-which(database$turnstile_3b==1),] -->
<!-- dataset$turnstile_3b <- NULL -->
<!-- dataset$Y_peak_3b <- NULL -->
<!-- dataset$Y_3b <- NULL -->
<!-- ############################################################################# -->


<!-- Y_bajo_umbral <- dataset$I.NO.EFECT.P1.PN + (dataset$I.EFECT.P1.PN - dataset$I.REM.P1.PN) -->
<!-- Y_sobre_umbral <- dataset$I.REM.P1.PN -->
<!-- Y_sobre_umbral_marip <- dataset$I.REM.P1.PN * dataset$turnstile_marip -->

<!-- Y_PN_resto <- dataset$I.PN.P2 + dataset$I.PN.P3 + dataset$I.PN.P4 -->
<!-- Y_ZP <- dataset$I.ZP.P1 + dataset$I.ZP.P2 + dataset$I.ZP.P3 + dataset$I.ZP.P4 -->

<!-- #Creating dataframe -->
<!-- data.all <- data.frame(dataset$TEXP, -->
<!--                        dataset$largo_ruta, -->
<!--                        dataset$U_TRI, -->
<!--                        dataset$DET, -->
<!--                        Y_bajo_umbral, -->
<!--                        Y_sobre_umbral, -->
<!--                        Y_sobre_umbral_marip, -->
<!--                        Y_PN_resto, -->
<!--                        Y_ZP, -->
<!--                        dataset$NI, -->
<!--                        dataset$NI_peak) -->

<!-- names(data.all) <- c("texp", -->
<!--                      "largo", -->
<!--                      "TRI", -->
<!--                      "DET", -->

<!--                      "Y_bajo_umbral_P1", -->
<!--                      "Y_sobre_umbral_P1", -->
<!--                      "Y_sobre_umbral_marip_P1", -->

<!--                      "Y_PN", -->
<!--                      "Y_ZP", -->

<!--                      "NI", -->
<!--                      "NI_peak") -->


<!-- #Fitting the model -->
<!-- modelo_18 <- lm(as.formula("texp~."), data = data.all) -->
<!-- summary(modelo_18) -->

<!-- ``` -->

<!-- ### Modelo 19 (X=3) -->

<!-- $T = c + t_{L} \cdot L + t_{TRI} \cdot TRI + t_{s} \cdot S + t_{Y} \cdot Y_{PN_{1}} + \Big( t_{Y}^{'} + t_{Y}^{''} \cdot \gamma_{marip} \Big) \cdot Y_{rmte_{PN1}} + t_{Y}^{'''} \cdot Y_{PN} + t_{Y}^{''''} \cdot Y_{ZP} + \Big( t_{I} + t_{I}^{'} \cdot \gamma_{peak} \Big) \cdot N_{I}$ -->

<!-- ```{r Modelo19, echo=FALSE} -->

<!-- ############################################################################# -->
<!-- #Setting working directory -->
<!-- setwd("/Users/diego/Desktop/Evasion/01_analisis/03_datos/12_Bases_modelo/") -->

<!-- #Reading input files -->
<!-- database <- read.csv(file = "data_modelo_X3.csv", header = TRUE, sep = ";") -->

<!-- #Cambiando unidad de medida de largo del recorrido (Kms.) -->
<!-- database$largo_ruta <- database$largo_ruta/1000 -->

<!-- #One hot encoding for periods of time -->
<!-- periodos <- as.data.frame(model.matrix(~database$Periodo-1)) -->
<!-- names(periodos) <- sprintf("P%s",3:10) -->
<!-- periodo_punta <- periodos$P4 + periodos$P9 -->

<!-- database <- cbind(database, periodos) -->
<!-- database$Punta <- periodo_punta -->

<!-- #NI peak -->
<!-- database$NI_peak <- database$NI * periodo_punta -->

<!-- #Demanda en periodo punta -->
<!-- database$Y_peak <- database$Y * periodo_punta -->

<!-- #Agregando trimestre único -->
<!-- database$U_TRI <- database$TRI -->
<!-- database$U_TRI[which(substr(database$FECHA,1,4) == "2017" & database$TRI == 1)] <- 5 -->
<!-- database$U_TRI[which(substr(database$FECHA,1,4) == "2017" & database$TRI == 2)] <- 6 -->
<!-- database$U_TRI[which(substr(database$FECHA,1,4) == "2017" & database$TRI == 3)] <- 7 -->
<!-- database$U_TRI[which(substr(database$FECHA,1,4) == "2017" & database$TRI == 4)] <- 8 -->

<!-- #Variable por presencia de torniquete de tres brazos -->
<!-- database$turnstile_3b <- 0 -->
<!-- database$turnstile_3b[which(database$turnstile==1 & database$turnstile_marip==0)] <- 1 -->

<!-- #Demanda con torniquete mariposa y de trez brazos en periodos punta. -->
<!-- database$Y_peak_marip <- database$Y * periodo_punta * database$turnstile_marip -->
<!-- database$Y_peak_3b <- database$Y * periodo_punta * database$turnstile_3b -->

<!-- #Demanda con torniquete mariposa y torniquete de tres brazos. -->
<!-- database$Y_marip <- database$Y * database$turnstile_marip -->
<!-- database$Y_3b <- database$Y * database$turnstile_3b -->


<!-- #Se construye un dataset sin considerar torniquete de tres brazos -->
<!-- dataset <- database[-which(database$turnstile_3b==1),] -->
<!-- dataset$turnstile_3b <- NULL -->
<!-- dataset$Y_peak_3b <- NULL -->
<!-- dataset$Y_3b <- NULL -->
<!-- ############################################################################# -->


<!-- Y_bajo_umbral <- dataset$I.NO.EFECT.P1.PN + (dataset$I.EFECT.P1.PN - dataset$I.REM.P1.PN) -->
<!-- Y_sobre_umbral <- dataset$I.REM.P1.PN -->
<!-- Y_sobre_umbral_marip <- dataset$I.REM.P1.PN * dataset$turnstile_marip -->

<!-- Y_PN_resto <- dataset$I.PN.P2 + dataset$I.PN.P3 + dataset$I.PN.P4 -->
<!-- Y_ZP <- dataset$I.ZP.P1 + dataset$I.ZP.P2 + dataset$I.ZP.P3 + dataset$I.ZP.P4 -->

<!-- #Creating dataframe -->
<!-- data.all <- data.frame(dataset$TEXP, -->
<!--                        dataset$largo_ruta, -->
<!--                        dataset$U_TRI, -->
<!--                        dataset$DET, -->
<!--                        Y_bajo_umbral, -->
<!--                        Y_sobre_umbral, -->
<!--                        Y_sobre_umbral_marip, -->
<!--                        Y_PN_resto, -->
<!--                        Y_ZP, -->
<!--                        dataset$NI, -->
<!--                        dataset$NI_peak) -->

<!-- names(data.all) <- c("texp", -->
<!--                      "largo", -->
<!--                      "TRI", -->
<!--                      "DET", -->

<!--                      "Y_bajo_umbral_P1", -->
<!--                      "Y_sobre_umbral_P1", -->
<!--                      "Y_sobre_umbral_marip_P1", -->

<!--                      "Y_PN", -->
<!--                      "Y_ZP", -->

<!--                      "NI", -->
<!--                      "NI_peak") -->


<!-- #Fitting the model -->
<!-- modelo_19 <- lm(as.formula("texp~."), data = data.all) -->
<!-- summary(modelo_19) -->

<!-- ``` -->



<!-- ### Modelo 20 (X=4) -->

<!-- $T = c + t_{L} \cdot L + t_{TRI} \cdot TRI + t_{s} \cdot S + t_{Y} \cdot Y_{PN_{1}} + \Big( t_{Y}^{'} + t_{Y}^{''} \cdot \gamma_{marip} \Big) \cdot Y_{rmte_{PN1}} + t_{Y}^{'''} \cdot Y_{PN} + t_{Y}^{''''} \cdot Y_{ZP} + \Big( t_{I} + t_{I}^{'} \cdot \gamma_{peak} \Big) \cdot N_{I}$ -->


<!-- ```{r Modelo20, echo=FALSE} -->

<!-- ############################################################################# -->
<!-- #Setting working directory -->
<!-- setwd("/Users/diego/Desktop/Evasion/01_analisis/03_datos/12_Bases_modelo/") -->

<!-- #Reading input files -->
<!-- database <- read.csv(file = "data_modelo_X4.csv", header = TRUE, sep = ";") -->

<!-- #Cambiando unidad de medida de largo del recorrido (Kms.) -->
<!-- database$largo_ruta <- database$largo_ruta/1000 -->

<!-- #One hot encoding for periods of time -->
<!-- periodos <- as.data.frame(model.matrix(~database$Periodo-1)) -->
<!-- names(periodos) <- sprintf("P%s",3:10) -->
<!-- periodo_punta <- periodos$P4 + periodos$P9 -->

<!-- database <- cbind(database, periodos) -->
<!-- database$Punta <- periodo_punta -->

<!-- #NI peak -->
<!-- database$NI_peak <- database$NI * periodo_punta -->

<!-- #Demanda en periodo punta -->
<!-- database$Y_peak <- database$Y * periodo_punta -->

<!-- #Agregando trimestre único -->
<!-- database$U_TRI <- database$TRI -->
<!-- database$U_TRI[which(substr(database$FECHA,1,4) == "2017" & database$TRI == 1)] <- 5 -->
<!-- database$U_TRI[which(substr(database$FECHA,1,4) == "2017" & database$TRI == 2)] <- 6 -->
<!-- database$U_TRI[which(substr(database$FECHA,1,4) == "2017" & database$TRI == 3)] <- 7 -->
<!-- database$U_TRI[which(substr(database$FECHA,1,4) == "2017" & database$TRI == 4)] <- 8 -->

<!-- #Variable por presencia de torniquete de tres brazos -->
<!-- database$turnstile_3b <- 0 -->
<!-- database$turnstile_3b[which(database$turnstile==1 & database$turnstile_marip==0)] <- 1 -->

<!-- #Demanda con torniquete mariposa y de trez brazos en periodos punta. -->
<!-- database$Y_peak_marip <- database$Y * periodo_punta * database$turnstile_marip -->
<!-- database$Y_peak_3b <- database$Y * periodo_punta * database$turnstile_3b -->

<!-- #Demanda con torniquete mariposa y torniquete de tres brazos. -->
<!-- database$Y_marip <- database$Y * database$turnstile_marip -->
<!-- database$Y_3b <- database$Y * database$turnstile_3b -->


<!-- #Se construye un dataset sin considerar torniquete de tres brazos -->
<!-- dataset <- database[-which(database$turnstile_3b==1),] -->
<!-- dataset$turnstile_3b <- NULL -->
<!-- dataset$Y_peak_3b <- NULL -->
<!-- dataset$Y_3b <- NULL -->
<!-- ############################################################################# -->


<!-- Y_bajo_umbral <- dataset$I.NO.EFECT.P1.PN + (dataset$I.EFECT.P1.PN - dataset$I.REM.P1.PN) -->
<!-- Y_sobre_umbral <- dataset$I.REM.P1.PN -->
<!-- Y_sobre_umbral_marip <- dataset$I.REM.P1.PN * dataset$turnstile_marip -->

<!-- Y_PN_resto <- dataset$I.PN.P2 + dataset$I.PN.P3 + dataset$I.PN.P4 -->
<!-- Y_ZP <- dataset$I.ZP.P1 + dataset$I.ZP.P2 + dataset$I.ZP.P3 + dataset$I.ZP.P4 -->

<!-- #Creating dataframe -->
<!-- data.all <- data.frame(dataset$TEXP, -->
<!--                        dataset$largo_ruta, -->
<!--                        dataset$U_TRI, -->
<!--                        dataset$DET, -->
<!--                        Y_bajo_umbral, -->
<!--                        Y_sobre_umbral, -->
<!--                        Y_sobre_umbral_marip, -->
<!--                        Y_PN_resto, -->
<!--                        Y_ZP, -->
<!--                        dataset$NI, -->
<!--                        dataset$NI_peak) -->

<!-- names(data.all) <- c("texp", -->
<!--                      "largo", -->
<!--                      "TRI", -->
<!--                      "DET", -->

<!--                      "Y_bajo_umbral_P1", -->
<!--                      "Y_sobre_umbral_P1", -->
<!--                      "Y_sobre_umbral_marip_P1", -->

<!--                      "Y_PN", -->
<!--                      "Y_ZP", -->

<!--                      "NI", -->
<!--                      "NI_peak") -->


<!-- #Fitting the model -->
<!-- modelo_20 <- lm(as.formula("texp~."), data = data.all) -->
<!-- summary(modelo_20) -->

<!-- ``` -->


<!-- ### Modelo 21 (X=5) -->

<!-- $T = c + t_{L} \cdot L + t_{TRI} \cdot TRI + t_{s} \cdot S + t_{Y} \cdot Y_{PN_{1}} + \Big( t_{Y}^{'} + t_{Y}^{''} \cdot \gamma_{marip} \Big) \cdot Y_{rmte_{PN1}} + t_{Y}^{'''} \cdot Y_{PN} + t_{Y}^{''''} \cdot Y_{ZP} + \Big( t_{I} + t_{I}^{'} \cdot \gamma_{peak} \Big) \cdot N_{I}$ -->

<!-- ```{r Modelo21, echo=FALSE} -->
<!-- ############################################################################# -->
<!-- #Setting working directory -->
<!-- setwd("/Users/diego/Desktop/Evasion/01_analisis/03_datos/12_Bases_modelo/") -->

<!-- #Reading input files -->
<!-- database <- read.csv(file = "data_modelo_X5.csv", header = TRUE, sep = ";") -->

<!-- #Cambiando unidad de medida de largo del recorrido (Kms.) -->
<!-- database$largo_ruta <- database$largo_ruta/1000 -->

<!-- #One hot encoding for periods of time -->
<!-- periodos <- as.data.frame(model.matrix(~database$Periodo-1)) -->
<!-- names(periodos) <- sprintf("P%s",3:10) -->
<!-- periodo_punta <- periodos$P4 + periodos$P9 -->

<!-- database <- cbind(database, periodos) -->
<!-- database$Punta <- periodo_punta -->

<!-- #NI peak -->
<!-- database$NI_peak <- database$NI * periodo_punta -->

<!-- #Demanda en periodo punta -->
<!-- database$Y_peak <- database$Y * periodo_punta -->

<!-- #Agregando trimestre único -->
<!-- database$U_TRI <- database$TRI -->
<!-- database$U_TRI[which(substr(database$FECHA,1,4) == "2017" & database$TRI == 1)] <- 5 -->
<!-- database$U_TRI[which(substr(database$FECHA,1,4) == "2017" & database$TRI == 2)] <- 6 -->
<!-- database$U_TRI[which(substr(database$FECHA,1,4) == "2017" & database$TRI == 3)] <- 7 -->
<!-- database$U_TRI[which(substr(database$FECHA,1,4) == "2017" & database$TRI == 4)] <- 8 -->

<!-- #Variable por presencia de torniquete de tres brazos -->
<!-- database$turnstile_3b <- 0 -->
<!-- database$turnstile_3b[which(database$turnstile==1 & database$turnstile_marip==0)] <- 1 -->

<!-- #Demanda con torniquete mariposa y de trez brazos en periodos punta. -->
<!-- database$Y_peak_marip <- database$Y * periodo_punta * database$turnstile_marip -->
<!-- database$Y_peak_3b <- database$Y * periodo_punta * database$turnstile_3b -->

<!-- #Demanda con torniquete mariposa y torniquete de tres brazos. -->
<!-- database$Y_marip <- database$Y * database$turnstile_marip -->
<!-- database$Y_3b <- database$Y * database$turnstile_3b -->


<!-- #Se construye un dataset sin considerar torniquete de tres brazos -->
<!-- dataset <- database[-which(database$turnstile_3b==1),] -->
<!-- dataset$turnstile_3b <- NULL -->
<!-- dataset$Y_peak_3b <- NULL -->
<!-- dataset$Y_3b <- NULL -->
<!-- ############################################################################# -->


<!-- Y_bajo_umbral <- dataset$I.NO.EFECT.P1.PN + (dataset$I.EFECT.P1.PN - dataset$I.REM.P1.PN) -->
<!-- Y_sobre_umbral <- dataset$I.REM.P1.PN -->
<!-- Y_sobre_umbral_marip <- dataset$I.REM.P1.PN * dataset$turnstile_marip -->

<!-- Y_PN_resto <- dataset$I.PN.P2 + dataset$I.PN.P3 + dataset$I.PN.P4 -->
<!-- Y_ZP <- dataset$I.ZP.P1 + dataset$I.ZP.P2 + dataset$I.ZP.P3 + dataset$I.ZP.P4 -->

<!-- #Creating dataframe -->
<!-- data.all <- data.frame(dataset$TEXP, -->
<!--                        dataset$largo_ruta, -->
<!--                        dataset$U_TRI, -->
<!--                        dataset$DET, -->
<!--                        Y_bajo_umbral, -->
<!--                        Y_sobre_umbral, -->
<!--                        Y_sobre_umbral_marip, -->
<!--                        Y_PN_resto, -->
<!--                        Y_ZP, -->
<!--                        dataset$NI, -->
<!--                        dataset$NI_peak) -->

<!-- names(data.all) <- c("texp", -->
<!--                      "largo", -->
<!--                      "TRI", -->
<!--                      "DET", -->

<!--                      "Y_bajo_umbral_P1", -->
<!--                      "Y_sobre_umbral_P1", -->
<!--                      "Y_sobre_umbral_marip_P1", -->

<!--                      "Y_PN", -->
<!--                      "Y_ZP", -->

<!--                      "NI", -->
<!--                      "NI_peak") -->


<!-- #Fitting the model -->
<!-- modelo_21 <- lm(as.formula("texp~."), data = data.all) -->
<!-- summary(modelo_21) -->
<!-- ``` -->


<!-- ### Modelo 22 (X=6) -->

<!-- $T = c + t_{L} \cdot L + t_{TRI} \cdot TRI + t_{s} \cdot S + t_{Y} \cdot Y_{PN_{1}} + \Big( t_{Y}^{'} + t_{Y}^{''} \cdot \gamma_{marip} \Big) \cdot Y_{rmte_{PN1}} + t_{Y}^{'''} \cdot Y_{PN} + t_{Y}^{''''} \cdot Y_{ZP} + \Big( t_{I} + t_{I}^{'} \cdot \gamma_{peak} \Big) \cdot N_{I}$ -->

<!-- ```{r Modelo22, echo=FALSE} -->

<!-- ############################################################################# -->
<!-- #Setting working directory -->
<!-- setwd("/Users/diego/Desktop/Evasion/01_analisis/03_datos/12_Bases_modelo/") -->

<!-- #Reading input files -->
<!-- database <- read.csv(file = "data_modelo_X6.csv", header = TRUE, sep = ";") -->

<!-- #Cambiando unidad de medida de largo del recorrido (Kms.) -->
<!-- database$largo_ruta <- database$largo_ruta/1000 -->

<!-- #One hot encoding for periods of time -->
<!-- periodos <- as.data.frame(model.matrix(~database$Periodo-1)) -->
<!-- names(periodos) <- sprintf("P%s",3:10) -->
<!-- periodo_punta <- periodos$P4 + periodos$P9 -->

<!-- database <- cbind(database, periodos) -->
<!-- database$Punta <- periodo_punta -->

<!-- #NI peak -->
<!-- database$NI_peak <- database$NI * periodo_punta -->

<!-- #Demanda en periodo punta -->
<!-- database$Y_peak <- database$Y * periodo_punta -->

<!-- #Agregando trimestre único -->
<!-- database$U_TRI <- database$TRI -->
<!-- database$U_TRI[which(substr(database$FECHA,1,4) == "2017" & database$TRI == 1)] <- 5 -->
<!-- database$U_TRI[which(substr(database$FECHA,1,4) == "2017" & database$TRI == 2)] <- 6 -->
<!-- database$U_TRI[which(substr(database$FECHA,1,4) == "2017" & database$TRI == 3)] <- 7 -->
<!-- database$U_TRI[which(substr(database$FECHA,1,4) == "2017" & database$TRI == 4)] <- 8 -->

<!-- #Variable por presencia de torniquete de tres brazos -->
<!-- database$turnstile_3b <- 0 -->
<!-- database$turnstile_3b[which(database$turnstile==1 & database$turnstile_marip==0)] <- 1 -->

<!-- #Demanda con torniquete mariposa y de trez brazos en periodos punta. -->
<!-- database$Y_peak_marip <- database$Y * periodo_punta * database$turnstile_marip -->
<!-- database$Y_peak_3b <- database$Y * periodo_punta * database$turnstile_3b -->

<!-- #Demanda con torniquete mariposa y torniquete de tres brazos. -->
<!-- database$Y_marip <- database$Y * database$turnstile_marip -->
<!-- database$Y_3b <- database$Y * database$turnstile_3b -->


<!-- #Se construye un dataset sin considerar torniquete de tres brazos -->
<!-- dataset <- database[-which(database$turnstile_3b==1),] -->
<!-- dataset$turnstile_3b <- NULL -->
<!-- dataset$Y_peak_3b <- NULL -->
<!-- dataset$Y_3b <- NULL -->
<!-- ############################################################################# -->


<!-- Y_bajo_umbral <- dataset$I.NO.EFECT.P1.PN + (dataset$I.EFECT.P1.PN - dataset$I.REM.P1.PN) -->
<!-- Y_sobre_umbral <- dataset$I.REM.P1.PN -->
<!-- Y_sobre_umbral_marip <- dataset$I.REM.P1.PN * dataset$turnstile_marip -->

<!-- Y_PN_resto <- dataset$I.PN.P2 + dataset$I.PN.P3 + dataset$I.PN.P4 -->
<!-- Y_ZP <- dataset$I.ZP.P1 + dataset$I.ZP.P2 + dataset$I.ZP.P3 + dataset$I.ZP.P4 -->

<!-- #Creating dataframe -->
<!-- data.all <- data.frame(dataset$TEXP, -->
<!--                        dataset$largo_ruta, -->
<!--                        dataset$U_TRI, -->
<!--                        dataset$DET, -->
<!--                        Y_bajo_umbral, -->
<!--                        Y_sobre_umbral, -->
<!--                        Y_sobre_umbral_marip, -->
<!--                        Y_PN_resto, -->
<!--                        Y_ZP, -->
<!--                        dataset$NI, -->
<!--                        dataset$NI_peak) -->

<!-- names(data.all) <- c("texp", -->
<!--                      "largo", -->
<!--                      "TRI", -->
<!--                      "DET", -->

<!--                      "Y_bajo_umbral_P1", -->
<!--                      "Y_sobre_umbral_P1", -->
<!--                      "Y_sobre_umbral_marip_P1", -->

<!--                      "Y_PN", -->
<!--                      "Y_ZP", -->

<!--                      "NI", -->
<!--                      "NI_peak") -->


<!-- #Fitting the model -->
<!-- modelo_22 <- lm(as.formula("texp~."), data = data.all) -->
<!-- summary(modelo_22) -->

<!-- ``` -->


<!-- ### Modelo 23 (X=7) -->

<!-- $T = c + t_{L} \cdot L + t_{TRI} \cdot TRI + t_{s} \cdot S + t_{Y} \cdot Y_{PN_{1}} + \Big( t_{Y}^{'} + t_{Y}^{''} \cdot \gamma_{marip} \Big) \cdot Y_{rmte_{PN1}} + t_{Y}^{'''} \cdot Y_{PN} + t_{Y}^{''''} \cdot Y_{ZP} + \Big( t_{I} + t_{I}^{'} \cdot \gamma_{peak} \Big) \cdot N_{I}$ -->

<!-- ```{r Modelo23, echo=FALSE} -->
<!-- ############################################################################# -->
<!-- #Setting working directory -->
<!-- setwd("/Users/diego/Desktop/Evasion/01_analisis/03_datos/12_Bases_modelo/") -->

<!-- #Reading input files -->
<!-- database <- read.csv(file = "data_modelo_X7.csv", header = TRUE, sep = ";") -->

<!-- #Cambiando unidad de medida de largo del recorrido (Kms.) -->
<!-- database$largo_ruta <- database$largo_ruta/1000 -->

<!-- #One hot encoding for periods of time -->
<!-- periodos <- as.data.frame(model.matrix(~database$Periodo-1)) -->
<!-- names(periodos) <- sprintf("P%s",3:10) -->
<!-- periodo_punta <- periodos$P4 + periodos$P9 -->

<!-- database <- cbind(database, periodos) -->
<!-- database$Punta <- periodo_punta -->

<!-- #NI peak -->
<!-- database$NI_peak <- database$NI * periodo_punta -->

<!-- #Demanda en periodo punta -->
<!-- database$Y_peak <- database$Y * periodo_punta -->

<!-- #Agregando trimestre único -->
<!-- database$U_TRI <- database$TRI -->
<!-- database$U_TRI[which(substr(database$FECHA,1,4) == "2017" & database$TRI == 1)] <- 5 -->
<!-- database$U_TRI[which(substr(database$FECHA,1,4) == "2017" & database$TRI == 2)] <- 6 -->
<!-- database$U_TRI[which(substr(database$FECHA,1,4) == "2017" & database$TRI == 3)] <- 7 -->
<!-- database$U_TRI[which(substr(database$FECHA,1,4) == "2017" & database$TRI == 4)] <- 8 -->

<!-- #Variable por presencia de torniquete de tres brazos -->
<!-- database$turnstile_3b <- 0 -->
<!-- database$turnstile_3b[which(database$turnstile==1 & database$turnstile_marip==0)] <- 1 -->

<!-- #Demanda con torniquete mariposa y de trez brazos en periodos punta. -->
<!-- database$Y_peak_marip <- database$Y * periodo_punta * database$turnstile_marip -->
<!-- database$Y_peak_3b <- database$Y * periodo_punta * database$turnstile_3b -->

<!-- #Demanda con torniquete mariposa y torniquete de tres brazos. -->
<!-- database$Y_marip <- database$Y * database$turnstile_marip -->
<!-- database$Y_3b <- database$Y * database$turnstile_3b -->


<!-- #Se construye un dataset sin considerar torniquete de tres brazos -->
<!-- dataset <- database[-which(database$turnstile_3b==1),] -->
<!-- dataset$turnstile_3b <- NULL -->
<!-- dataset$Y_peak_3b <- NULL -->
<!-- dataset$Y_3b <- NULL -->
<!-- ############################################################################# -->


<!-- Y_bajo_umbral <- dataset$I.NO.EFECT.P1.PN + (dataset$I.EFECT.P1.PN - dataset$I.REM.P1.PN) -->
<!-- Y_sobre_umbral <- dataset$I.REM.P1.PN -->
<!-- Y_sobre_umbral_marip <- dataset$I.REM.P1.PN * dataset$turnstile_marip -->

<!-- Y_PN_resto <- dataset$I.PN.P2 + dataset$I.PN.P3 + dataset$I.PN.P4 -->
<!-- Y_ZP <- dataset$I.ZP.P1 + dataset$I.ZP.P2 + dataset$I.ZP.P3 + dataset$I.ZP.P4 -->

<!-- #Creating dataframe -->
<!-- data.all <- data.frame(dataset$TEXP, -->
<!--                        dataset$largo_ruta, -->
<!--                        dataset$U_TRI, -->
<!--                        dataset$DET, -->
<!--                        Y_bajo_umbral, -->
<!--                        Y_sobre_umbral, -->
<!--                        Y_sobre_umbral_marip, -->
<!--                        Y_PN_resto, -->
<!--                        Y_ZP, -->
<!--                        dataset$NI, -->
<!--                        dataset$NI_peak) -->

<!-- names(data.all) <- c("texp", -->
<!--                      "largo", -->
<!--                      "TRI", -->
<!--                      "DET", -->

<!--                      "Y_bajo_umbral_P1", -->
<!--                      "Y_sobre_umbral_P1", -->
<!--                      "Y_sobre_umbral_marip_P1", -->

<!--                      "Y_PN", -->
<!--                      "Y_ZP", -->

<!--                      "NI", -->
<!--                      "NI_peak") -->


<!-- #Fitting the model -->
<!-- modelo_23 <- lm(as.formula("texp~."), data = data.all) -->
<!-- summary(modelo_23) -->
<!-- ``` -->


<!-- ### Modelo 24 (X=8) -->

<!-- $T = c + t_{L} \cdot L + t_{TRI} \cdot TRI + t_{s} \cdot S + t_{Y} \cdot Y_{PN_{1}} + \Big( t_{Y}^{'} + t_{Y}^{''} \cdot \gamma_{marip} \Big) \cdot Y_{rmte_{PN1}} + t_{Y}^{'''} \cdot Y_{PN} + t_{Y}^{''''} \cdot Y_{ZP} + \Big( t_{I} + t_{I}^{'} \cdot \gamma_{peak} \Big) \cdot N_{I}$ -->

<!-- ```{r Modelo24, echo=FALSE} -->

<!-- ############################################################################# -->
<!-- #Setting working directory -->
<!-- setwd("/Users/diego/Desktop/Evasion/01_analisis/03_datos/12_Bases_modelo/") -->

<!-- #Reading input files -->
<!-- database <- read.csv(file = "data_modelo_X8.csv", header = TRUE, sep = ";") -->

<!-- #Cambiando unidad de medida de largo del recorrido (Kms.) -->
<!-- database$largo_ruta <- database$largo_ruta/1000 -->

<!-- #One hot encoding for periods of time -->
<!-- periodos <- as.data.frame(model.matrix(~database$Periodo-1)) -->
<!-- names(periodos) <- sprintf("P%s",3:10) -->
<!-- periodo_punta <- periodos$P4 + periodos$P9 -->

<!-- database <- cbind(database, periodos) -->
<!-- database$Punta <- periodo_punta -->

<!-- #NI peak -->
<!-- database$NI_peak <- database$NI * periodo_punta -->

<!-- #Demanda en periodo punta -->
<!-- database$Y_peak <- database$Y * periodo_punta -->

<!-- #Agregando trimestre único -->
<!-- database$U_TRI <- database$TRI -->
<!-- database$U_TRI[which(substr(database$FECHA,1,4) == "2017" & database$TRI == 1)] <- 5 -->
<!-- database$U_TRI[which(substr(database$FECHA,1,4) == "2017" & database$TRI == 2)] <- 6 -->
<!-- database$U_TRI[which(substr(database$FECHA,1,4) == "2017" & database$TRI == 3)] <- 7 -->
<!-- database$U_TRI[which(substr(database$FECHA,1,4) == "2017" & database$TRI == 4)] <- 8 -->

<!-- #Variable por presencia de torniquete de tres brazos -->
<!-- database$turnstile_3b <- 0 -->
<!-- database$turnstile_3b[which(database$turnstile==1 & database$turnstile_marip==0)] <- 1 -->

<!-- #Demanda con torniquete mariposa y de trez brazos en periodos punta. -->
<!-- database$Y_peak_marip <- database$Y * periodo_punta * database$turnstile_marip -->
<!-- database$Y_peak_3b <- database$Y * periodo_punta * database$turnstile_3b -->

<!-- #Demanda con torniquete mariposa y torniquete de tres brazos. -->
<!-- database$Y_marip <- database$Y * database$turnstile_marip -->
<!-- database$Y_3b <- database$Y * database$turnstile_3b -->


<!-- #Se construye un dataset sin considerar torniquete de tres brazos -->
<!-- dataset <- database[-which(database$turnstile_3b==1),] -->
<!-- dataset$turnstile_3b <- NULL -->
<!-- dataset$Y_peak_3b <- NULL -->
<!-- dataset$Y_3b <- NULL -->
<!-- ############################################################################# -->


<!-- Y_bajo_umbral <- dataset$I.NO.EFECT.P1.PN + (dataset$I.EFECT.P1.PN - dataset$I.REM.P1.PN) -->
<!-- Y_sobre_umbral <- dataset$I.REM.P1.PN -->
<!-- Y_sobre_umbral_marip <- dataset$I.REM.P1.PN * dataset$turnstile_marip -->

<!-- Y_PN_resto <- dataset$I.PN.P2 + dataset$I.PN.P3 + dataset$I.PN.P4 -->
<!-- Y_ZP <- dataset$I.ZP.P1 + dataset$I.ZP.P2 + dataset$I.ZP.P3 + dataset$I.ZP.P4 -->

<!-- #Creating dataframe -->
<!-- data.all <- data.frame(dataset$TEXP, -->
<!--                        dataset$largo_ruta, -->
<!--                        dataset$U_TRI, -->
<!--                        dataset$DET, -->
<!--                        Y_bajo_umbral, -->
<!--                        Y_sobre_umbral, -->
<!--                        Y_sobre_umbral_marip, -->
<!--                        Y_PN_resto, -->
<!--                        Y_ZP, -->
<!--                        dataset$NI, -->
<!--                        dataset$NI_peak) -->

<!-- names(data.all) <- c("texp", -->
<!--                      "largo", -->
<!--                      "TRI", -->
<!--                      "DET", -->

<!--                      "Y_bajo_umbral_P1", -->
<!--                      "Y_sobre_umbral_P1", -->
<!--                      "Y_sobre_umbral_marip_P1", -->

<!--                      "Y_PN", -->
<!--                      "Y_ZP", -->

<!--                      "NI", -->
<!--                      "NI_peak") -->


<!-- #Fitting the model -->
<!-- modelo_24 <- lm(as.formula("texp~."), data = data.all) -->
<!-- summary(modelo_24) -->

<!-- ``` -->


<!-- ## Dummies por ruta -->

<!-- Debido a la imposibilidad de cálculo del número de intersecciones semaforizadas de manera rigurosa (bases poco prolijas) y a probable correlación entre el número de intersecciones semaforizadas con el número de detenciones (0.62) se decide probar con dummies por cada una de las rutas (servicio-sentido). Esto tiene a su vez como argumento que el número de intersecciones y paraderos son características en generales propias del trazado del servicio-sentido. Este modelo, además considera el largo del recorrido y la demanda como variables explicativas del tiempo de viaje. Este procedimiento, permitirá además determinar la robustez de los modelos presentados anteriormente. -->

<!-- Dentro del modelo finalmente reportado, solo se consideran variables de rutas estadísticamente significativas, eliminando a través de un loop todas aquellas que no lo sean en cada iteración. -->

<!-- ### Modelo 25 -->

<!-- Este modelo es el mejor especificado en la demanda, pero utilizando dummies por servicio - sentido. -->

<!-- $T = c + \Big( t_{Y} + t_{Y}^{'} \cdot \gamma_{marip} + \Big(t_{Y}^{''} + t_{Y}^{'''} \cdot \gamma_{marip}  \Big) \cdot \gamma_{peak} \Big) \cdot Y_{PN_{1}} + t_{Y}^{'''''} \cdot Y_{PN} + t_{Y}^{''''} \cdot Y_{ZP}  +  \sum_{r}  t_{r} \cdot  \gamma_{r}$ -->

<!-- ```{r Modelo25, echo=FALSE} -->

<!-- #Variables asociadas a transferencia de pasajeros -->
<!-- Y_PN1 <- dataset$I.PN.P1 -->
<!-- Y_PN1_marip <- dataset$I.PN.P1 * dataset$turnstile_marip -->
<!-- Y_PN1_peak <- dataset$I.PN.P1 * dataset$Punta -->
<!-- Y_PN1_peak_marip <- dataset$I.PN.P1 * dataset$Punta * dataset$turnstile_marip -->

<!-- Y_PN_resto <- dataset$I.PN.P2 + dataset$I.PN.P3 + dataset$I.PN.P4 -->
<!-- Y_ZP <- dataset$I.ZP.P1 + dataset$I.ZP.P2 + dataset$I.ZP.P3 + dataset$I.ZP.P4 -->


<!-- #Variables dummies por servicio-sentido -->
<!-- dataset$COD_USU_SENTIDO <- as.character(dataset$COD_USU_SENTIDO) -->
<!-- rutas <- as.data.frame(model.matrix(~dataset$COD_USU_SENTIDO-1)) -->
<!-- names(rutas) <- substr(names(rutas),nchar(names(rutas)) - 3,nchar(names(rutas))) -->

<!-- #Deleting route 101I (base) -->
<!-- rutas <- rutas[,-1] -->

<!-- ind_pvalor <- length(dataset) -->


<!-- while(length(ind_pvalor) != 0){ -->

<!--   data.all <- data.frame(dataset$TEXP, -->
<!--                          Y_PN1, -->
<!--                          Y_PN1_marip, -->
<!--                          Y_PN1_peak, -->
<!--                          Y_PN1_peak_marip, -->
<!--                          Y_PN_resto, -->
<!--                          Y_ZP) -->

<!--   names(data.all) <- c("texp", -->
<!--                        "Y_PN_P1", -->
<!--                        "Y_PN_P1_marip", -->
<!--                        "Y_PN_P1_peak", -->
<!--                        "Y_PN_P1_peak_marip", -->
<!--                        "Y_PN", -->
<!--                        "Y_ZP") -->

<!--   data.all <- cbind(data.all, rutas) -->

<!--   modelo_25 <- lm(as.formula("texp~."), data = data.all) -->
<!--   test_summary <- data.frame(summary(modelo_25)[[4]]) -->
<!--   test_summary <- test_summary[8:nrow(test_summary),] -->

<!--   ind_pvalor <- which(test_summary$Pr...t.. > 0.05) -->

<!--   #Keeping routes statistically significant -->
<!--   if(length(ind_pvalor != 0)){rutas <- rutas[,-ind_pvalor]} -->
<!-- } -->

<!-- summary(modelo_25) -->

<!-- ``` -->


<!-- ### Modelo 26 -->

<!-- Extensión del modelo anterior. Se agrega el largo del recorrido. -->

<!-- $T = c + t_{L} \cdot L + \Big( t_{Y} + t_{Y}^{'} \cdot \gamma_{marip} + \Big(t_{Y}^{''} + t_{Y}^{'''} \cdot \gamma_{marip}  \Big) \cdot \gamma_{peak} \Big) \cdot Y_{PN_{1}} + t_{Y}^{'''''} \cdot Y_{PN} + t_{Y}^{''''} \cdot Y_{ZP}  +  \sum_{r}  t_{r} \cdot  \gamma_{r}$ -->

<!-- ```{r Modelo26, echo=FALSE} -->
<!-- #Variables asociadas a transferencia de pasajeros -->
<!-- Y_PN1 <- dataset$I.PN.P1 -->
<!-- Y_PN1_marip <- dataset$I.PN.P1 * dataset$turnstile_marip -->
<!-- Y_PN1_peak <- dataset$I.PN.P1 * dataset$Punta -->
<!-- Y_PN1_peak_marip <- dataset$I.PN.P1 * dataset$Punta * dataset$turnstile_marip -->

<!-- Y_PN_resto <- dataset$I.PN.P2 + dataset$I.PN.P3 + dataset$I.PN.P4 -->
<!-- Y_ZP <- dataset$I.ZP.P1 + dataset$I.ZP.P2 + dataset$I.ZP.P3 + dataset$I.ZP.P4 -->


<!-- #Variables dummies por servicio-sentido -->
<!-- dataset$COD_USU_SENTIDO <- as.character(dataset$COD_USU_SENTIDO) -->
<!-- rutas <- as.data.frame(model.matrix(~dataset$COD_USU_SENTIDO-1)) -->
<!-- names(rutas) <- substr(names(rutas),nchar(names(rutas)) - 3,nchar(names(rutas))) -->

<!-- #Deleting route 101I (base) -->
<!-- rutas <- rutas[,-1] -->

<!-- ind_pvalor <- length(dataset) -->


<!-- while(length(ind_pvalor) != 0){ -->

<!--   data.all <- data.frame(dataset$TEXP, -->
<!--                          dataset$largo_ruta, -->
<!--                          Y_PN1, -->
<!--                          Y_PN1_marip, -->
<!--                          Y_PN1_peak, -->
<!--                          Y_PN1_peak_marip, -->
<!--                          Y_PN_resto, -->
<!--                          Y_ZP) -->

<!--   names(data.all) <- c("texp", -->
<!--                        "largo", -->
<!--                        "Y_PN_P1", -->
<!--                        "Y_PN_P1_marip", -->
<!--                        "Y_PN_P1_peak", -->
<!--                        "Y_PN_P1_peak_marip", -->
<!--                        "Y_PN", -->
<!--                        "Y_ZP") -->

<!--   data.all <- cbind(data.all, rutas) -->

<!--   modelo_26 <- lm(as.formula("texp~."), data = data.all) -->
<!--   test_summary <- data.frame(summary(modelo_26)[[4]]) -->
<!--   test_summary <- test_summary[9:nrow(test_summary),] -->

<!--   ind_pvalor <- which(test_summary$Pr...t.. > 0.05) -->

<!--   #Keeping routes statistically significant -->
<!--   if(length(ind_pvalor != 0)){rutas <- rutas[,-ind_pvalor]} -->
<!-- } -->

<!-- summary(modelo_26) -->
<!-- ``` -->

<!-- ### Modelo 27 -->

<!-- Modelo 25 pero agregando variable asociada al TRImestre de medición. -->

<!-- $T = c + t_{TRI} \cdot TRI + \Big( t_{Y} + t_{Y}^{'} \cdot \gamma_{marip} + \Big(t_{Y}^{''} + t_{Y}^{'''} \cdot \gamma_{marip}  \Big) \cdot \gamma_{peak} \Big) \cdot Y_{PN_{1}} + t_{Y}^{'''''} \cdot Y_{PN} + t_{Y}^{''''} \cdot Y_{ZP}  +  \sum_{r}  t_{r} \cdot  \gamma_{r}$ -->

<!-- ```{r Modelo27, echo=FALSE} -->

<!-- Y_PN1 <- dataset$I.PN.P1 -->
<!-- Y_PN1_marip <- dataset$I.PN.P1 * dataset$turnstile_marip -->
<!-- Y_PN1_peak <- dataset$I.PN.P1 * dataset$Punta -->
<!-- Y_PN1_peak_marip <- dataset$I.PN.P1 * dataset$Punta * dataset$turnstile_marip -->

<!-- Y_PN_resto <- dataset$I.PN.P2 + dataset$I.PN.P3 + dataset$I.PN.P4 -->
<!-- Y_ZP <- dataset$I.ZP.P1 + dataset$I.ZP.P2 + dataset$I.ZP.P3 + dataset$I.ZP.P4 -->


<!-- #Variables dummies por servicio-sentido -->
<!-- dataset$COD_USU_SENTIDO <- as.character(dataset$COD_USU_SENTIDO) -->
<!-- rutas <- as.data.frame(model.matrix(~dataset$COD_USU_SENTIDO-1)) -->
<!-- names(rutas) <- substr(names(rutas),nchar(names(rutas)) - 3,nchar(names(rutas))) -->

<!-- #Deleting route 101I (base) -->
<!-- rutas <- rutas[,-1] -->

<!-- ind_pvalor <- length(dataset) -->


<!-- while(length(ind_pvalor) != 0){ -->

<!--   data.all <- data.frame(dataset$TEXP, -->
<!--                          dataset$U_TRI, -->
<!--                          Y_PN1, -->
<!--                          Y_PN1_marip, -->
<!--                          Y_PN1_peak, -->
<!--                          Y_PN1_peak_marip, -->
<!--                          Y_PN_resto, -->
<!--                          Y_ZP) -->

<!--   names(data.all) <- c("texp", -->
<!--                        "TRI", -->
<!--                        "Y_PN_P1", -->
<!--                        "Y_PN_P1_marip", -->
<!--                        "Y_PN_P1_peak", -->
<!--                        "Y_PN_P1_peak_marip", -->
<!--                        "Y_PN", -->
<!--                        "Y_ZP") -->

<!--   data.all <- cbind(data.all, rutas) -->

<!--   modelo_27 <- lm(as.formula("texp~."), data = data.all) -->
<!--   test_summary <- data.frame(summary(modelo_27)[[4]]) -->
<!--   test_summary <- test_summary[9:nrow(test_summary),] -->

<!--   ind_pvalor <- which(test_summary$Pr...t.. > 0.05) -->

<!--   #Keeping routes statistically significant -->
<!--   if(length(ind_pvalor != 0)){rutas <- rutas[,-ind_pvalor]} -->
<!-- } -->

<!-- summary(modelo_27) -->

<!-- ``` -->

<!-- ### Modelo 28 -->

<!-- Modelo 25 pero considerando variable asociada tanto al largo como al TRImestre de medición, $i.e.$ -->

<!-- $T = c + t_{L} \cdot L + t_{TRI} \cdot TRI + \Big( t_{Y} + t_{Y}^{'} \cdot \gamma_{marip} + \Big(t_{Y}^{''} + t_{Y}^{'''} \cdot \gamma_{marip}  \Big) \cdot \gamma_{peak} \Big) \cdot Y_{PN_{1}} + t_{Y}^{'''''} \cdot Y_{PN} + t_{Y}^{''''} \cdot Y_{ZP}  +  \sum_{r}  t_{r} \cdot  \gamma_{r}$ -->

<!-- ```{r Modelo28, echo=FALSE} -->

<!-- Y_PN1 <- dataset$I.PN.P1 -->
<!-- Y_PN1_marip <- dataset$I.PN.P1 * dataset$turnstile_marip -->
<!-- Y_PN1_peak <- dataset$I.PN.P1 * dataset$Punta -->
<!-- Y_PN1_peak_marip <- dataset$I.PN.P1 * dataset$Punta * dataset$turnstile_marip -->

<!-- Y_PN_resto <- dataset$I.PN.P2 + dataset$I.PN.P3 + dataset$I.PN.P4 -->
<!-- Y_ZP <- dataset$I.ZP.P1 + dataset$I.ZP.P2 + dataset$I.ZP.P3 + dataset$I.ZP.P4 -->


<!-- #Variables dummies por servicio-sentido -->
<!-- dataset$COD_USU_SENTIDO <- as.character(dataset$COD_USU_SENTIDO) -->
<!-- rutas <- as.data.frame(model.matrix(~dataset$COD_USU_SENTIDO-1)) -->
<!-- names(rutas) <- substr(names(rutas),nchar(names(rutas)) - 3,nchar(names(rutas))) -->

<!-- #Deleting route 101I (base) -->
<!-- rutas <- rutas[,-1] -->

<!-- ind_pvalor <- length(dataset) -->


<!-- while(length(ind_pvalor) != 0){ -->

<!--   data.all <- data.frame(dataset$TEXP, -->
<!--                          dataset$largo_ruta, -->
<!--                          dataset$U_TRI, -->
<!--                          Y_PN1, -->
<!--                          Y_PN1_marip, -->
<!--                          Y_PN1_peak, -->
<!--                          Y_PN1_peak_marip, -->
<!--                          Y_PN_resto, -->
<!--                          Y_ZP) -->

<!--   names(data.all) <- c("texp", -->
<!--                        "largo", -->
<!--                        "TRI", -->
<!--                        "Y_PN_P1", -->
<!--                        "Y_PN_P1_marip", -->
<!--                        "Y_PN_P1_peak", -->
<!--                        "Y_PN_P1_peak_marip", -->
<!--                        "Y_PN", -->
<!--                        "Y_ZP") -->

<!--   data.all <- cbind(data.all, rutas) -->

<!--   modelo_28 <- lm(as.formula("texp~."), data = data.all) -->
<!--   test_summary <- data.frame(summary(modelo_28)[[4]]) -->
<!--   test_summary <- test_summary[10:nrow(test_summary),] -->

<!--   ind_pvalor <- which(test_summary$Pr...t.. > 0.05) -->

<!--   #Keeping routes statistically significant -->
<!--   if(length(ind_pvalor != 0)){rutas <- rutas[,-ind_pvalor]} -->
<!-- } -->

<!-- summary(modelo_28) -->

<!-- ``` -->


<!-- ### Modelo 29 -->

<!-- Modelo anterior, pero eliminando variable estadísticamente no significativa (mariposa_peak) -->

<!-- ```{r Modelo29, echo=FALSE} -->

<!-- Y_PN1 <- dataset$I.PN.P1 -->
<!-- Y_PN1_marip <- dataset$I.PN.P1 * dataset$turnstile_marip -->
<!-- Y_PN1_peak <- dataset$I.PN.P1 * dataset$Punta -->
<!-- Y_PN1_peak_marip <- dataset$I.PN.P1 * dataset$Punta * dataset$turnstile_marip -->

<!-- Y_PN_resto <- dataset$I.PN.P2 + dataset$I.PN.P3 + dataset$I.PN.P4 -->
<!-- Y_ZP <- dataset$I.ZP.P1 + dataset$I.ZP.P2 + dataset$I.ZP.P3 + dataset$I.ZP.P4 -->


<!-- #Variables dummies por servicio-sentido -->
<!-- dataset$COD_USU_SENTIDO <- as.character(dataset$COD_USU_SENTIDO) -->
<!-- rutas <- as.data.frame(model.matrix(~dataset$COD_USU_SENTIDO-1)) -->
<!-- names(rutas) <- substr(names(rutas),nchar(names(rutas)) - 3,nchar(names(rutas))) -->

<!-- #Deleting route 101I (base) -->
<!-- rutas <- rutas[,-1] -->

<!-- ind_pvalor <- length(dataset) -->


<!-- while(length(ind_pvalor) != 0){ -->

<!--   data.all <- data.frame(dataset$TEXP, -->
<!--                          dataset$largo_ruta, -->
<!--                          dataset$U_TRI, -->
<!--                          Y_PN1, -->
<!--                          Y_PN1_marip, -->
<!--                          Y_PN1_peak, -->
<!--                          Y_PN_resto, -->
<!--                          Y_ZP) -->

<!--   names(data.all) <- c("texp", -->
<!--                        "largo", -->
<!--                        "TRI", -->
<!--                        "Y_PN_P1", -->
<!--                        "Y_PN_P1_marip", -->
<!--                        "Y_PN_P1_peak", -->
<!--                        "Y_PN", -->
<!--                        "Y_ZP") -->


<!--   data.all <- cbind(data.all, rutas) -->

<!--   modelo_29 <- lm(as.formula("texp~."), data = data.all) -->
<!--   test_summary <- data.frame(summary(modelo_29)[[4]]) -->
<!--   test_summary <- test_summary[9:nrow(test_summary),] -->

<!--   ind_pvalor <- which(test_summary$Pr...t.. > 0.05) -->

<!--   #Keeping routes statistically significant -->
<!--   if(length(ind_pvalor != 0)){rutas <- rutas[,-ind_pvalor]} -->
<!-- } -->

<!-- summary(modelo_29) -->

<!-- ``` -->

<!-- ### Modelo 30 -->

<!-- ```{r Modelo30, echo=FALSE} -->


<!-- #Variables dummies por servicio-sentido -->
<!-- dataset$COD_USU_SENTIDO <- as.character(dataset$COD_USU_SENTIDO) -->
<!-- rutas <- as.data.frame(model.matrix(~dataset$COD_USU_SENTIDO-1)) -->
<!-- names(rutas) <- substr(names(rutas),nchar(names(rutas)) - 3,nchar(names(rutas))) -->

<!-- #Deleting route 101I (base) -->
<!-- rutas <- rutas[,-1] -->

<!-- ind_pvalor <- length(dataset) -->


<!-- while(length(ind_pvalor) != 0){ -->

<!--   data.all <- data.frame(dataset$TEXP, -->
<!--                          dataset$largo_ruta, -->
<!--                          dataset$I.PN, -->
<!--                          dataset$I.ZP) -->

<!--   names(data.all) <- c("texp", -->
<!--                        "largo", -->
<!--                        "Y_PN", -->
<!--                        "Y_ZP") -->


<!--   data.all <- cbind(data.all, rutas) -->

<!--   modelo_30 <- lm(as.formula("texp~."), data = data.all) -->
<!--   test_summary <- data.frame(summary(modelo_30)[[4]]) -->
<!--   test_summary <- test_summary[5:nrow(test_summary),] -->

<!--   ind_pvalor <- which(test_summary$Pr...t.. > 0.05) -->

<!--   #Keeping routes statistically significant -->
<!--   if(length(ind_pvalor != 0)){rutas <- rutas[,-ind_pvalor]} -->
<!-- } -->

<!-- summary(modelo_30) -->

<!-- ``` -->










